"use strict";var buffer=require("buffer"),Signature=require("../crypto/signature"),Script=require("../script"),Output=require("./output"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),BN=require("../crypto/bn"),Hash=require("../crypto/hash"),ECDSA=require("../crypto/ecdsa"),$=require("../util/preconditions"),Interpreter=require("../script/interpreter"),_=require("../util/_"),SIGHASH_SINGLE_BUG=Buffer.from("0000000000000000000000000000000000000000000000000000000000000001","hex"),BITS_64_ON="ffffffffffffffff",DEFAULT_SIGN_FLAGS=Interpreter.SCRIPT_ENABLE_SIGHASH_FORKID,sighashPreimageForForkId=function(e,r,t,i,u){var n=e.inputs[t];function f(e,r){var t=new BufferWriter;_.isUndefined(r)?_.each(e.outputs,(function(e){e.toBufferWriter(t)})):e.outputs[r].toBufferWriter(t);var i=t.toBuffer();return Hash.sha256sha256(i)}$.checkArgument(u instanceof BN,"For ForkId=0 signatures, satoshis or complete input must be provided");var s=Buffer.alloc(32),a=Buffer.alloc(32),S=Buffer.alloc(32);r&Signature.SIGHASH_ANYONECANPAY||(s=function(e){var r=new BufferWriter;_.each(e.inputs,(function(e){r.writeReverse(e.prevTxId),r.writeUInt32LE(e.outputIndex)}));var t=r.toBuffer();return Hash.sha256sha256(t)}(e)),r&Signature.SIGHASH_ANYONECANPAY||(31&r)===Signature.SIGHASH_SINGLE||(31&r)===Signature.SIGHASH_NONE||(a=function(e){var r=new BufferWriter;_.each(e.inputs,(function(e){r.writeUInt32LE(e.sequenceNumber)}));var t=r.toBuffer();return Hash.sha256sha256(t)}(e)),(31&r)!==Signature.SIGHASH_SINGLE&&(31&r)!==Signature.SIGHASH_NONE?S=f(e):(31&r)===Signature.SIGHASH_SINGLE&&t<e.outputs.length&&(S=f(e,t));var o=new BufferWriter;o.writeInt32LE(e.version),o.write(s),o.write(a),o.writeReverse(n.prevTxId),o.writeUInt32LE(n.outputIndex),o.writeVarintNum(i.toBuffer().length),o.write(i.toBuffer()),o.writeUInt64LEBN(u);var h=n.sequenceNumber;return o.writeUInt32LE(h),o.write(S),o.writeUInt32LE(e.nLockTime),o.writeUInt32LE(r>>>0),o.toBuffer()},sighashPreimage=function(e,r,t,i,u,n){var f=require("./transaction"),s=require("./input");_.isUndefined(n)&&(n=DEFAULT_SIGN_FLAGS);var a,S=f.shallowCopy(e);if(i=new Script(i),n&Interpreter.SCRIPT_ENABLE_REPLAY_PROTECTION&&(r=(16711680|57005^r>>8)<<8|255&r),r&Signature.SIGHASH_FORKID&&n&Interpreter.SCRIPT_ENABLE_SIGHASH_FORKID)return sighashPreimageForForkId(S,r,t,i,u);for(i.removeCodeseparators(),a=0;a<S.inputs.length;a++)S.inputs[a]=new s(S.inputs[a]).setScript(Script.empty());if(S.inputs[t]=new s(S.inputs[t]).setScript(i),(31&r)===Signature.SIGHASH_NONE||(31&r)===Signature.SIGHASH_SINGLE)for(a=0;a<S.inputs.length;a++)a!==t&&(S.inputs[a].sequenceNumber=0);if((31&r)===Signature.SIGHASH_NONE)S.outputs=[];else if((31&r)===Signature.SIGHASH_SINGLE){if(t>=S.outputs.length)return SIGHASH_SINGLE_BUG;for(S.outputs.length=t+1,a=0;a<t;a++)S.outputs[a]=new Output({satoshis:BN.fromBuffer(buffer.Buffer.from(BITS_64_ON,"hex")),script:Script.empty()})}return r&Signature.SIGHASH_ANYONECANPAY&&(S.inputs=[S.inputs[t]]),(new BufferWriter).write(S.toBuffer()).writeInt32LE(r).toBuffer()},sighash=function(e,r,t,i,u,n){var f=sighashPreimage(e,r,t,i,u,n);if(0===f.compare(SIGHASH_SINGLE_BUG))return f;var s=Hash.sha256sha256(f);return new BufferReader(s).readReverse()};function sign(e,r,t,i,u,n,f){var s=sighash(e,t,i,u,n,f);return ECDSA.sign(s,r,"little").set({nhashtype:t})}function verify(e,r,t,i,u,n,f){$.checkArgument(!_.isUndefined(e)),$.checkArgument(!_.isUndefined(r)&&!_.isUndefined(r.nhashtype));var s=sighash(e,r.nhashtype,i,u,n,f);return ECDSA.verify(s,r,t,"little")}module.exports={sighashPreimage,sighash,sign,verify};