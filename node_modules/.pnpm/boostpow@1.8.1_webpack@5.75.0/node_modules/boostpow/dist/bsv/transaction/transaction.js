"use strict";var _=require("../util/_"),$=require("../util/preconditions"),buffer=require("buffer"),errors=require("../errors"),JSUtil=require("../util/javas"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Varint=require("../encoding/varint"),Hash=require("../crypto/hash"),Signature=require("../crypto/signature"),Sighash=require("./sighash"),Address=require("../address"),UnspentOutput=require("./unspentoutput"),Input=require("./input"),PublicKeyHashInput=Input.PublicKeyHash,PublicKeyInput=Input.PublicKey,MultiSigScriptHashInput=Input.MultiSigScriptHash,MultiSigInput=Input.MultiSig,Output=require("./output"),Script=require("../script"),PrivateKey=require("../privatekey"),BN=require("../crypto/bn");function Transaction(t){if(!(this instanceof Transaction))return new Transaction(t);if(this.inputs=[],this.outputs=[],this._inputAmount=void 0,this._outputAmount=void 0,t){if(t instanceof Transaction)return Transaction.shallowCopy(t);if(JSUtil.isHexa(t))this.fromString(t);else if(Buffer.isBuffer(t))this.fromBuffer(t);else{if(!_.isObject(t))throw new errors.InvalidArgument("Must provide an object or string to deserialize a transaction");this.fromObject(t)}}else this._newTransaction()}var CURRENT_VERSION=1,DEFAULT_NLOCKTIME=0,MAX_BLOCK_SIZE=1e6;Transaction.DUST_AMOUNT=546,Transaction.FEE_SECURITY_MARGIN=150,Transaction.MAX_MONEY=21e14,Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT=5e8,Transaction.NLOCKTIME_MAX_VALUE=4294967295,Transaction.FEE_PER_KB=500,Transaction.CHANGE_OUTPUT_MAX_SIZE=62,Transaction.shallowCopy=function(t){return new Transaction(t.toBuffer())};var hashProperty={configurable:!1,enumerable:!0,get:function(){return this._hash=new BufferReader(this._getHash()).readReverse().toString("hex"),this._hash}};Object.defineProperty(Transaction.prototype,"hash",hashProperty),Object.defineProperty(Transaction.prototype,"id",hashProperty);var ioProperty={configurable:!1,enumerable:!0,get:function(){return this._getInputAmount()}};Object.defineProperty(Transaction.prototype,"inputAmount",ioProperty),ioProperty.get=function(){return this._getOutputAmount()},Object.defineProperty(Transaction.prototype,"outputAmount",ioProperty),Transaction.prototype._getHash=function(){return Hash.sha256sha256(this.toBuffer())},Transaction.prototype.serialize=function(t){return!0===t||t&&t.disableAll?this.uncheckedSerialize():this.checkedSerialize(t)},Transaction.prototype.uncheckedSerialize=Transaction.prototype.toString=function(){return this.toBuffer().toString("hex")},Transaction.prototype.checkedSerialize=function(t){var n=this.getSerializationError(t);if(n)throw n.message+=" - For more information please see: https://bsv.io/api/lib/transaction#serialization-checks",n;return this.uncheckedSerialize()},Transaction.prototype.invalidSatoshis=function(){for(var t=!1,n=0;n<this.outputs.length;n++)this.outputs[n].invalidSatoshis()&&(t=!0);return t},Transaction.prototype.getSerializationError=function(t){if(t=t||{},this.invalidSatoshis())return new errors.Transaction.InvalidSatoshis;var n,i=this._getUnspentValue();return i<0?t.disableMoreOutputThanInput||(n=new errors.Transaction.InvalidOutputAmountSum):n=this._hasFeeError(t,i),n||this._hasDustOutputs(t)||this._isMissingSignatures(t)},Transaction.prototype._hasFeeError=function(t,n){if(!_.isUndefined(this._fee)&&this._fee!==n)return new errors.Transaction.FeeError.Different("Unspent value is "+n+" but specified fee is "+this._fee);if(!t.disableLargeFees){var i=Math.floor(Transaction.FEE_SECURITY_MARGIN*this._estimateFee());if(n>i)return this._missingChange()?new errors.Transaction.ChangeAddressMissing("Fee is too large and no change address was provided"):new errors.Transaction.FeeError.TooLarge("expected less than "+i+" but got "+n)}},Transaction.prototype._missingChange=function(){return!this._changeScript},Transaction.prototype._hasDustOutputs=function(t){var n,i;if(!t.disableDustOutputs)for(n in this.outputs)if((i=this.outputs[n]).satoshis<Transaction.DUST_AMOUNT&&!i.script.isDataOut()&&!i.script.isSafeDataOut())return new errors.Transaction.DustOutputs},Transaction.prototype._isMissingSignatures=function(t){if(!t.disableIsFullySigned)return this.isFullySigned()?void 0:new errors.Transaction.MissingSignatures},Transaction.prototype.inspect=function(){return"<Transaction: "+this.uncheckedSerialize()+">"},Transaction.prototype.toBuffer=function(){var t=new BufferWriter;return this.toBufferWriter(t).toBuffer()},Transaction.prototype.toBufferWriter=function(t){return t.writeInt32LE(this.version),t.writeVarintNum(this.inputs.length),_.each(this.inputs,(function(n){n.toBufferWriter(t)})),t.writeVarintNum(this.outputs.length),_.each(this.outputs,(function(n){n.toBufferWriter(t)})),t.writeUInt32LE(this.nLockTime),t},Transaction.prototype.fromBuffer=function(t){var n=new BufferReader(t);return this.fromBufferReader(n)},Transaction.prototype.fromBufferReader=function(t){var n,i,e;for($.checkArgument(!t.finished(),"No transaction data received"),this.version=t.readInt32LE(),i=t.readVarintNum(),n=0;n<i;n++){var r=Input.fromBufferReader(t);this.inputs.push(r)}for(e=t.readVarintNum(),n=0;n<e;n++)this.outputs.push(Output.fromBufferReader(t));return this.nLockTime=t.readUInt32LE(),this},Transaction.prototype.toObject=Transaction.prototype.toJSON=function(){var t=[];this.inputs.forEach((function(n){t.push(n.toObject())}));var n=[];this.outputs.forEach((function(t){n.push(t.toObject())}));var i={hash:this.hash,version:this.version,inputs:t,outputs:n,nLockTime:this.nLockTime};return this._changeScript&&(i.changeScript=this._changeScript.toString()),_.isUndefined(this._changeIndex)||(i.changeIndex=this._changeIndex),_.isUndefined(this._fee)||(i.fee=this._fee),i},Transaction.prototype.fromObject=function(t){$.checkArgument(_.isObject(t)||t instanceof Transaction);var n,i=this;return n=t instanceof Transaction?n.toObject():t,_.each(n.inputs,(function(t){if(t.output&&t.output.script){var n,e=new Script(t.output.script);if(e.isPublicKeyHashOut())n=new Input.PublicKeyHash(t);else if(e.isScriptHashOut()&&t.publicKeys&&t.threshold)n=new Input.MultiSigScriptHash(t,t.publicKeys,t.threshold,t.signatures);else{if(!e.isPublicKeyOut())throw new errors.Transaction.Input.UnsupportedScript(t.output.script);n=new Input.PublicKey(t)}i.addInput(n)}else i.uncheckedAddInput(new Input(t))})),_.each(n.outputs,(function(t){i.addOutput(new Output(t))})),n.changeIndex&&(this._changeIndex=n.changeIndex),n.changeScript&&(this._changeScript=new Script(n.changeScript)),n.fee&&(this._fee=n.fee),this.nLockTime=n.nLockTime,this.version=n.version,this._checkConsistency(t),this},Transaction.prototype._checkConsistency=function(t){_.isUndefined(this._changeIndex)||($.checkState(this._changeScript,"Change script is expected."),$.checkState(this.outputs[this._changeIndex],"Change index points to undefined output."),$.checkState(this.outputs[this._changeIndex].script.toString()===this._changeScript.toString(),"Change output has an unexpected script.")),t&&t.hash&&$.checkState(t.hash===this.hash,"Hash in object does not match transaction hash.")},Transaction.prototype.lockUntilDate=function(t){if($.checkArgument(t),_.isNumber(t)&&t<Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT)throw new errors.Transaction.LockTimeTooEarly;_.isDate(t)&&(t=t.getTime()/1e3);for(var n=0;n<this.inputs.length;n++)this.inputs[n].sequenceNumber===Input.DEFAULT_SEQNUMBER&&(this.inputs[n].sequenceNumber=Input.DEFAULT_LOCKTIME_SEQNUMBER);return this.nLockTime=t,this},Transaction.prototype.lockUntilBlockHeight=function(t){if($.checkArgument(_.isNumber(t)),t>=Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT)throw new errors.Transaction.BlockHeightTooHigh;if(t<0)throw new errors.Transaction.NLockTimeOutOfRange;for(var n=0;n<this.inputs.length;n++)this.inputs[n].sequenceNumber===Input.DEFAULT_SEQNUMBER&&(this.inputs[n].sequenceNumber=Input.DEFAULT_LOCKTIME_SEQNUMBER);return this.nLockTime=t,this},Transaction.prototype.getLockTime=function(){return this.nLockTime?this.nLockTime<Transaction.NLOCKTIME_BLOCKHEIGHT_LIMIT?this.nLockTime:new Date(1e3*this.nLockTime):null},Transaction.prototype.fromString=function(t){this.fromBuffer(buffer.Buffer.from(t,"hex"))},Transaction.prototype._newTransaction=function(){this.version=CURRENT_VERSION,this.nLockTime=DEFAULT_NLOCKTIME},Transaction.prototype.from=function(t,n,i){if(_.isArray(t)){var e=this;return _.each(t,(function(t){e.from(t,n,i)})),this}return _.some(this.inputs,(function(n){return n.prevTxId.toString("hex")===t.txId&&n.outputIndex===t.outputIndex}))||(n&&i?this._fromMultisigUtxo(t,n,i):this._fromNonP2SH(t)),this},Transaction.prototype._fromNonP2SH=function(t){var n;n=(t=new UnspentOutput(t)).script.isPublicKeyHashOut()?PublicKeyHashInput:t.script.isPublicKeyOut()?PublicKeyInput:Input,this.addInput(new n({output:new Output({script:t.script,satoshis:t.satoshis}),prevTxId:t.txId,outputIndex:t.outputIndex,script:Script.empty()}))},Transaction.prototype._fromMultisigUtxo=function(t,n,i){var e;if($.checkArgument(i<=n.length,"Number of required signatures must be greater than the number of public keys"),(t=new UnspentOutput(t)).script.isMultisigOut())e=MultiSigInput;else{if(!t.script.isScriptHashOut())throw new Error("@TODO");e=MultiSigScriptHashInput}this.addInput(new e({output:new Output({script:t.script,satoshis:t.satoshis}),prevTxId:t.txId,outputIndex:t.outputIndex,script:Script.empty()},n,i))},Transaction.prototype.addInput=function(t,n,i){if($.checkArgumentType(t,Input,"input"),!t.output&&(_.isUndefined(n)||_.isUndefined(i)))throw new errors.Transaction.NeedMoreInfo("Need information about the UTXO script and satoshis");return t.output||!n||_.isUndefined(i)||(n=n instanceof Script?n:new Script(n),$.checkArgumentType(i,"number","satoshis"),t.output=new Output({script:n,satoshis:i})),this.uncheckedAddInput(t)},Transaction.prototype.uncheckedAddInput=function(t){return $.checkArgumentType(t,Input,"input"),this.inputs.push(t),this._inputAmount=void 0,this._updateChangeOutput(),this},Transaction.prototype.hasAllUtxoInfo=function(){return _.every(this.inputs.map((function(t){return!!t.output})))},Transaction.prototype.fee=function(t){return $.checkArgument(_.isNumber(t),"amount must be a number"),this._fee=t,this._updateChangeOutput(),this},Transaction.prototype.feePerKb=function(t){return $.checkArgument(_.isNumber(t),"amount must be a number"),this._feePerKb=t,this._updateChangeOutput(),this},Transaction.prototype.change=function(t){return $.checkArgument(t,"address is required"),this._changeScript=Script.fromAddress(t),this._updateChangeOutput(),this},Transaction.prototype.getChangeOutput=function(){return _.isUndefined(this._changeIndex)?null:this.outputs[this._changeIndex]},Transaction.prototype.to=function(t,n){if(_.isArray(t)){var i=this;return _.each(t,(function(t){i.to(t.address,t.satoshis)})),this}return $.checkArgument(JSUtil.isNaturalNumber(n),"Amount is expected to be a positive integer"),this.addOutput(new Output({script:Script(new Address(t)),satoshis:n})),this},Transaction.prototype.addData=function(t){return this.addOutput(new Output({script:Script.buildDataOut(t),satoshis:0})),this},Transaction.prototype.addSafeData=function(t){return this.addOutput(new Output({script:Script.buildSafeDataOut(t),satoshis:0})),this},Transaction.prototype.addOutput=function(t){return $.checkArgumentType(t,Output,"output"),this._addOutput(t),this._updateChangeOutput(),this},Transaction.prototype.clearOutputs=function(){return this.outputs=[],this._clearSignatures(),this._outputAmount=void 0,this._changeIndex=void 0,this._updateChangeOutput(),this},Transaction.prototype._addOutput=function(t){this.outputs.push(t),this._outputAmount=void 0},Transaction.prototype._getOutputAmount=function(){if(_.isUndefined(this._outputAmount)){var t=this;this._outputAmount=0,_.each(this.outputs,(function(n){t._outputAmount+=n.satoshis}))}return this._outputAmount},Transaction.prototype._getInputAmount=function(){if(_.isUndefined(this._inputAmount)){var t=this;this._inputAmount=0,_.each(this.inputs,(function(n){if(_.isUndefined(n.output))throw new errors.Transaction.Input.MissingPreviousOutput;t._inputAmount+=n.output.satoshis}))}return this._inputAmount},Transaction.prototype._updateChangeOutput=function(){if(this._changeScript){this._clearSignatures(),_.isUndefined(this._changeIndex)||this._removeOutput(this._changeIndex),this._changeIndex=this.outputs.length,this._addOutput(new Output({script:this._changeScript,satoshis:0}));var t=this._getUnspentValue()-this.getFee();this._removeOutput(this._changeIndex),this._changeIndex=void 0,t>=Transaction.DUST_AMOUNT&&(this._changeIndex=this.outputs.length,this._addOutput(new Output({script:this._changeScript,satoshis:t})))}},Transaction.prototype.getFee=function(){return this.isCoinbase()?0:_.isUndefined(this._fee)?this._changeScript?this._estimateFee():this._getUnspentValue():this._fee},Transaction.prototype._estimateFee=function(){var t=this._estimateSize();return Math.ceil(t/1e3*(this._feePerKb||Transaction.FEE_PER_KB))},Transaction.prototype._getUnspentValue=function(){return this._getInputAmount()-this._getOutputAmount()},Transaction.prototype._clearSignatures=function(){_.each(this.inputs,(function(t){t.clearSignatures()}))},Transaction.prototype._estimateSize=function(){var t=8;return t+=Varint(this.inputs.length).toBuffer().length,t+=Varint(this.outputs.length).toBuffer().length,_.each(this.inputs,(function(n){t+=n._estimateSize()})),_.each(this.outputs,(function(n){t+=n.getSize()})),t},Transaction.prototype._removeOutput=function(t){var n=this.outputs[t];this.outputs=_.without(this.outputs,n),this._outputAmount=void 0},Transaction.prototype.removeOutput=function(t){this._removeOutput(t),this._updateChangeOutput()},Transaction.prototype.sort=function(){return this.sortInputs((function(t){var n=Array.prototype.concat.apply([],t);return n.sort((function(t,n){return t.prevTxId.compare(n.prevTxId)||t.outputIndex-n.outputIndex})),n})),this.sortOutputs((function(t){var n=Array.prototype.concat.apply([],t);return n.sort((function(t,n){return t.satoshis-n.satoshis||t.script.toBuffer().compare(n.script.toBuffer())})),n})),this},Transaction.prototype.shuffleOutputs=function(){return this.sortOutputs(_.shuffle)},Transaction.prototype.sortOutputs=function(t){var n=t(this.outputs);return this._newOutputOrder(n)},Transaction.prototype.sortInputs=function(t){return this.inputs=t(this.inputs),this._clearSignatures(),this},Transaction.prototype._newOutputOrder=function(t){if(this.outputs.length!==t.length||0!==_.difference(this.outputs,t).length)throw new errors.Transaction.InvalidSorting;if(!_.isUndefined(this._changeIndex)){var n=this.outputs[this._changeIndex];this._changeIndex=t.indexOf(n)}return this.outputs=t,this},Transaction.prototype.removeInput=function(t,n){var i;if(i=!n&&_.isNumber(t)?t:_.findIndex(this.inputs,(function(i){return i.prevTxId.toString("hex")===t&&i.outputIndex===n})),i<0||i>=this.inputs.length)throw new errors.Transaction.InvalidIndex(i,this.inputs.length);var e=this.inputs[i];this.inputs=_.without(this.inputs,e),this._inputAmount=void 0,this._updateChangeOutput()},Transaction.prototype.sign=function(t,n){$.checkState(this.hasAllUtxoInfo(),"Not all utxo information is available to sign the transaction.");var i=this;return _.isArray(t)?(_.each(t,(function(t){i.sign(t,n)})),this):(_.each(this.getSignatures(t,n),(function(t){i.applySignature(t)})),this)},Transaction.prototype.getSignatures=function(t,n){t=new PrivateKey(t),n=n||Signature.SIGHASH_ALL|Signature.SIGHASH_FORKID;var i=this,e=[],r=Hash.sha256ripemd160(t.publicKey.toBuffer());return _.each(this.inputs,(function(s,u){_.each(s.getSignatures(i,t,u,n,r),(function(t){e.push(t)}))})),e},Transaction.prototype.applySignature=function(t){return this.inputs[t.inputIndex].addSignature(this,t),this},Transaction.prototype.isFullySigned=function(){return _.each(this.inputs,(function(t){if(t.isFullySigned===Input.prototype.isFullySigned)throw new errors.Transaction.UnableToVerifySignature("Unrecognized script kind, or not enough information to execute script.This usually happens when creating a transaction from a serialized transaction")})),_.every(_.map(this.inputs,(function(t){return t.isFullySigned()})))},Transaction.prototype.isValidSignature=function(t){if(this.inputs[t.inputIndex].isValidSignature===Input.prototype.isValidSignature)throw new errors.Transaction.UnableToVerifySignature("Unrecognized script kind, or not enough information to execute script.This usually happens when creating a transaction from a serialized transaction");return this.inputs[t.inputIndex].isValidSignature(this,t)},Transaction.prototype.verifySignature=function(t,n,i,e,r,s){return Sighash.verify(this,t,n,i,e,r,s)},Transaction.prototype.verify=function(){if(0===this.inputs.length)return"transaction txins empty";if(0===this.outputs.length)return"transaction txouts empty";for(var t=new BN(0),n=0;n<this.outputs.length;n++){var i=this.outputs[n];if(i.invalidSatoshis())return"transaction txout "+n+" satoshis is invalid";if(i._satoshisBN.gt(new BN(Transaction.MAX_MONEY,10)))return"transaction txout "+n+" greater than MAX_MONEY";if((t=t.add(i._satoshisBN)).gt(new BN(Transaction.MAX_MONEY)))return"transaction txout "+n+" total output greater than MAX_MONEY"}if(this.toBuffer().length>MAX_BLOCK_SIZE)return"transaction over the maximum block size";var e={};for(n=0;n<this.inputs.length;n++){var r=this.inputs[n],s=r.prevTxId+":"+r.outputIndex;if(!_.isUndefined(e[s]))return"transaction input "+n+" duplicate input";e[s]=!0}if(this.isCoinbase()){var u=this.inputs[0]._scriptBuffer;if(u.length<2||u.length>100)return"coinbase transaction script size invalid"}else for(n=0;n<this.inputs.length;n++)if(this.inputs[n].isNull())return"transaction input "+n+" has null input";return!0},Transaction.prototype.isCoinbase=function(){return 1===this.inputs.length&&this.inputs[0].isNull()},module.exports=Transaction;