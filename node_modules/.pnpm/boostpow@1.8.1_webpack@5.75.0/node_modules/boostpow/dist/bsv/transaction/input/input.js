"use strict";var _=require("../../util/_"),$=require("../../util/preconditions"),errors=require("../../errors"),BufferWriter=require("../../encoding/bufferwriter"),buffer=require("buffer"),JSUtil=require("../../util/javas"),Script=require("../../script"),Sighash=require("../sighash"),Output=require("../output"),MAXINT=4294967295,DEFAULT_RBF_SEQNUMBER=MAXINT-2,DEFAULT_SEQNUMBER=MAXINT,DEFAULT_LOCKTIME_SEQNUMBER=MAXINT-1;function Input(t){return this instanceof Input?t?this._fromObject(t):void 0:new Input(t)}Input.MAXINT=MAXINT,Input.DEFAULT_SEQNUMBER=DEFAULT_SEQNUMBER,Input.DEFAULT_LOCKTIME_SEQNUMBER=DEFAULT_LOCKTIME_SEQNUMBER,Input.DEFAULT_RBF_SEQNUMBER=DEFAULT_RBF_SEQNUMBER,Input.BASE_SIZE=40,Object.defineProperty(Input.prototype,"script",{configurable:!1,enumerable:!0,get:function(){return this.isNull()?null:(this._script||(this._script=new Script(this._scriptBuffer),this._script._isInput=!0),this._script)}}),Input.fromObject=function(t){return $.checkArgument(_.isObject(t)),(new Input)._fromObject(t)},Input.prototype._fromObject=function(t){var e;if(e=_.isString(t.prevTxId)&&JSUtil.isHexa(t.prevTxId)?buffer.Buffer.from(t.prevTxId,"hex"):t.prevTxId,this.output=t.output?t.output instanceof Output?t.output:new Output(t.output):void 0,this.prevTxId=e||t.txidbuf,this.outputIndex=_.isUndefined(t.outputIndex)?t.txoutnum:t.outputIndex,this.sequenceNumber=_.isUndefined(t.sequenceNumber)?_.isUndefined(t.seqnum)?DEFAULT_SEQNUMBER:t.seqnum:t.sequenceNumber,_.isUndefined(t.script)&&_.isUndefined(t.scriptBuffer))throw new errors.Transaction.Input.MissingScript;return this.setScript(t.scriptBuffer||t.script),this},Input.prototype.toObject=Input.prototype.toJSON=function(){var t={prevTxId:this.prevTxId.toString("hex"),outputIndex:this.outputIndex,sequenceNumber:this.sequenceNumber,script:this._scriptBuffer.toString("hex")};return this.script&&(t.scriptString=this.script.toString()),this.output&&(t.output=this.output.toObject()),t},Input.fromBufferReader=function(t){var e=new Input;return e.prevTxId=t.readReverse(32),e.outputIndex=t.readUInt32LE(),e._scriptBuffer=t.readVarLengthBuffer(),e.sequenceNumber=t.readUInt32LE(),e},Input.prototype.toBufferWriter=function(t){t||(t=new BufferWriter),t.writeReverse(this.prevTxId),t.writeUInt32LE(this.outputIndex);var e=this._scriptBuffer;return t.writeVarintNum(e.length),t.write(e),t.writeUInt32LE(this.sequenceNumber),t},Input.prototype.setScript=function(t){if(this._script=null,t instanceof Script)this._script=t,this._script._isInput=!0,this._scriptBuffer=t.toBuffer();else if(null===t)this._script=Script.empty(),this._script._isInput=!0,this._scriptBuffer=this._script.toBuffer();else if(JSUtil.isHexa(t))this._scriptBuffer=buffer.Buffer.from(t,"hex");else if(_.isString(t))this._script=new Script(t),this._script._isInput=!0,this._scriptBuffer=this._script.toBuffer();else{if(!Buffer.isBuffer(t))throw new TypeError("Invalid argument type: script");this._scriptBuffer=buffer.Buffer.from(t)}return this},Input.prototype.getSignatures=function(){throw new errors.AbstractMethodInvoked("Trying to sign unsupported output type (only P2PKH and P2SH multisig inputs are supported) for input: "+JSON.stringify(this))},Input.prototype.isFullySigned=function(){throw new errors.AbstractMethodInvoked("Input#isFullySigned")},Input.prototype.isFinal=function(){return this.sequenceNumber===Input.MAXINT},Input.prototype.addSignature=function(){throw new errors.AbstractMethodInvoked("Input#addSignature")},Input.prototype.clearSignatures=function(){throw new errors.AbstractMethodInvoked("Input#clearSignatures")},Input.prototype.isValidSignature=function(t,e){return e.signature.nhashtype=e.sigtype,Sighash.verify(t,e.signature,e.publicKey,e.inputIndex,this.output.script,this.output.satoshisBN)},Input.prototype.isNull=function(){return"0000000000000000000000000000000000000000000000000000000000000000"===this.prevTxId.toString("hex")&&4294967295===this.outputIndex},Input.prototype._estimateSize=function(){return this.toBufferWriter().toBuffer().length},module.exports=Input;