"use strict";var _=require("../util/_"),BlockHeader=require("./blockheader"),BN=require("../crypto/bn"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),Transaction=require("../transaction"),$=require("../util/preconditions");function Block(r){return this instanceof Block?(_.extend(this,Block._from(r)),this):new Block(r)}Block.MAX_BLOCK_SIZE=128e6,Block._from=function(r){var e={};if(Buffer.isBuffer(r))e=Block._fromBufferReader(BufferReader(r));else{if(!_.isObject(r))throw new TypeError("Unrecognized argument for Block");e=Block._fromObject(r)}return e},Block._fromObject=function(r){var e=[];return r.transactions.forEach((function(r){r instanceof Transaction?e.push(r):e.push(Transaction().fromObject(r))})),{header:BlockHeader.fromObject(r.header),transactions:e}},Block.fromObject=function(r){var e=Block._fromObject(r);return new Block(e)},Block._fromBufferReader=function(r){var e={};$.checkState(!r.finished(),"No block data received"),e.header=BlockHeader.fromBufferReader(r);var t=r.readVarintNum();e.transactions=[];for(var o=0;o<t;o++)e.transactions.push(Transaction().fromBufferReader(r));return e},Block.fromBufferReader=function(r){$.checkArgument(r,"br is required");var e=Block._fromBufferReader(r);return new Block(e)},Block.fromBuffer=function(r){return Block.fromBufferReader(new BufferReader(r))},Block.fromString=function(r){var e=Buffer.from(r,"hex");return Block.fromBuffer(e)},Block.fromRawBlock=function(r){Buffer.isBuffer(r)||(r=Buffer.from(r,"binary"));var e=BufferReader(r);e.pos=Block.Values.START_OF_BLOCK;var t=Block._fromBufferReader(e);return new Block(t)},Block.prototype.toObject=Block.prototype.toJSON=function(){var r=[];return this.transactions.forEach((function(e){r.push(e.toObject())})),{header:this.header.toObject(),transactions:r}},Block.prototype.toBuffer=function(){return this.toBufferWriter().concat()},Block.prototype.toString=function(){return this.toBuffer().toString("hex")},Block.prototype.toBufferWriter=function(r){r||(r=new BufferWriter),r.write(this.header.toBuffer()),r.writeVarintNum(this.transactions.length);for(var e=0;e<this.transactions.length;e++)this.transactions[e].toBufferWriter(r);return r},Block.prototype.getTransactionHashes=function(){var r=[];if(0===this.transactions.length)return[Block.Values.NULL_HASH];for(var e=0;e<this.transactions.length;e++)r.push(this.transactions[e]._getHash());return r},Block.prototype.getMerkleTree=function(){for(var r=this.getTransactionHashes(),e=0,t=this.transactions.length;t>1;t=Math.floor((t+1)/2)){for(var o=0;o<t;o+=2){var n=Math.min(o+1,t-1),f=Buffer.concat([r[e+o],r[e+n]]);r.push(Hash.sha256sha256(f))}e+=t}return r},Block.prototype.getMerkleRoot=function(){var r=this.getMerkleTree();return r[r.length-1]},Block.prototype.validMerkleRoot=function(){var r=new BN(this.header.merkleRoot.toString("hex"),"hex"),e=new BN(this.getMerkleRoot().toString("hex"),"hex");return 0===r.cmp(e)},Block.prototype._getHash=function(){return this.header._getHash()};var idProperty={configurable:!1,enumerable:!0,get:function(){return this._id||(this._id=this.header.id),this._id},set:_.noop};Object.defineProperty(Block.prototype,"id",idProperty),Object.defineProperty(Block.prototype,"hash",idProperty),Block.prototype.inspect=function(){return"<Block "+this.id+">"},Block.Values={START_OF_BLOCK:8,NULL_HASH:Buffer.from("0000000000000000000000000000000000000000000000000000000000000000","hex")},module.exports=Block;