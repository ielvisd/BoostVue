"use strict";var _=require("../util/_"),BlockHeader=require("./blockheader"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),Transaction=require("../transaction"),errors=require("../errors"),$=require("../util/preconditions");function MerkleBlock(e){if(!(this instanceof MerkleBlock))return new MerkleBlock(e);var r={};if(Buffer.isBuffer(e))r=MerkleBlock._fromBufferReader(BufferReader(e));else{if(!_.isObject(e))throw new TypeError("Unrecognized argument for MerkleBlock");r={header:e.header instanceof BlockHeader?e.header:BlockHeader.fromObject(e.header),numTransactions:e.numTransactions,hashes:e.hashes,flags:e.flags}}return _.extend(this,r),this._flagBitsUsed=0,this._hashesUsed=0,this}MerkleBlock.fromBuffer=function(e){return MerkleBlock.fromBufferReader(BufferReader(e))},MerkleBlock.fromBufferReader=function(e){return new MerkleBlock(MerkleBlock._fromBufferReader(e))},MerkleBlock.prototype.toBuffer=function(){return this.toBufferWriter().concat()},MerkleBlock.prototype.toBufferWriter=function(e){e||(e=new BufferWriter),e.write(this.header.toBuffer()),e.writeUInt32LE(this.numTransactions),e.writeVarintNum(this.hashes.length);for(var r=0;r<this.hashes.length;r++)e.write(Buffer.from(this.hashes[r],"hex"));for(e.writeVarintNum(this.flags.length),r=0;r<this.flags.length;r++)e.writeUInt8(this.flags[r]);return e},MerkleBlock.prototype.toObject=MerkleBlock.prototype.toJSON=function(){return{header:this.header.toObject(),numTransactions:this.numTransactions,hashes:this.hashes,flags:this.flags}},MerkleBlock.prototype.validMerkleTree=function(){if($.checkState(_.isArray(this.flags),"MerkleBlock flags is not an array"),$.checkState(_.isArray(this.hashes),"MerkleBlock hashes is not an array"),this.hashes.length>this.numTransactions)return!1;if(8*this.flags.length<this.hashes.length)return!1;var e=this._calcTreeHeight(),r={hashesUsed:0,flagBitsUsed:0},t=this._traverseMerkleTree(e,0,r);return r.hashesUsed===this.hashes.length&&t.equals(this.header.merkleRoot)},MerkleBlock.prototype.filterdTxsHash=function(){throw new Error("filterdTxsHash has been deprecated. use filteredTxsHash.")},MerkleBlock.prototype.filteredTxsHash=function(){if($.checkState(_.isArray(this.flags),"MerkleBlock flags is not an array"),$.checkState(_.isArray(this.hashes),"MerkleBlock hashes is not an array"),this.hashes.length>this.numTransactions)throw new errors.MerkleBlock.InvalidMerkleTree;if(8*this.flags.length<this.hashes.length)throw new errors.MerkleBlock.InvalidMerkleTree;if(1===this.hashes.length)return[];var e=this._calcTreeHeight(),r={hashesUsed:0,flagBitsUsed:0},t=this._traverseMerkleTree(e,0,r,!0);if(r.hashesUsed!==this.hashes.length)throw new errors.MerkleBlock.InvalidMerkleTree;return t},MerkleBlock.prototype._traverseMerkleTree=function(e,r,t,s){if((t=t||{}).txs=t.txs||[],t.flagBitsUsed=t.flagBitsUsed||0,t.hashesUsed=t.hashesUsed||0,s=s||!1,t.flagBitsUsed>8*this.flags.length)return null;var a=this.flags[t.flagBitsUsed>>3]>>>(7&t.flagBitsUsed++)&1;if(0!==e&&a){var h=this._traverseMerkleTree(e-1,2*r,t),i=h;return 2*r+1<this._calcTreeWidth(e-1)&&(i=this._traverseMerkleTree(e-1,2*r+1,t)),s?t.txs:Hash.sha256sha256(Buffer.concat([h,i]))}if(t.hashesUsed>=this.hashes.length)return null;var n=this.hashes[t.hashesUsed++];return 0===e&&a&&t.txs.push(n),Buffer.from(n,"hex")},MerkleBlock.prototype._calcTreeWidth=function(e){return this.numTransactions+(1<<e)-1>>e},MerkleBlock.prototype._calcTreeHeight=function(){for(var e=0;this._calcTreeWidth(e)>1;)e++;return e},MerkleBlock.prototype.hasTransaction=function(e){$.checkArgument(!_.isUndefined(e),"tx cannot be undefined"),$.checkArgument(e instanceof Transaction||"string"==typeof e,'Invalid tx given, tx must be a "string" or "Transaction"');var r=e;e instanceof Transaction&&(r=Buffer.from(e.id,"hex").reverse().toString("hex"));var t=[],s=this._calcTreeHeight();return this._traverseMerkleTree(s,0,{txs:t}),-1!==t.indexOf(r)},MerkleBlock._fromBufferReader=function(e){$.checkState(!e.finished(),"No merkleblock data received");var r={};r.header=BlockHeader.fromBufferReader(e),r.numTransactions=e.readUInt32LE();var t=e.readVarintNum();r.hashes=[];for(var s=0;s<t;s++)r.hashes.push(e.read(32).toString("hex"));var a=e.readVarintNum();for(r.flags=[],s=0;s<a;s++)r.flags.push(e.readUInt8());return r},MerkleBlock.fromObject=function(e){return new MerkleBlock(e)},module.exports=MerkleBlock;