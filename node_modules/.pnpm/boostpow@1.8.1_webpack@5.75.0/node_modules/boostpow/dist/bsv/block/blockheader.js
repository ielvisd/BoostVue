"use strict";var _=require("../util/_"),BN=require("../crypto/bn"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),$=require("../util/preconditions"),GENESIS_BITS=486604799,BlockHeader=function e(r){if(!(this instanceof e))return new e(r);var t=e._from(r);return this.version=t.version,this.prevHash=t.prevHash,this.merkleRoot=t.merkleRoot,this.time=t.time,this.timestamp=t.time,this.bits=t.bits,this.nonce=t.nonce,t.hash&&$.checkState(this.hash===t.hash,"Argument object hash property does not match block hash."),this};BlockHeader._from=function(e){var r={};if(Buffer.isBuffer(e))r=BlockHeader._fromBufferReader(BufferReader(e));else{if(!_.isObject(e))throw new TypeError("Unrecognized argument for BlockHeader");r=BlockHeader._fromObject(e)}return r},BlockHeader._fromObject=function(e){$.checkArgument(e,"data is required");var r=e.prevHash,t=e.merkleRoot;return _.isString(e.prevHash)&&(r=Buffer.from(e.prevHash,"hex").reverse()),_.isString(e.merkleRoot)&&(t=Buffer.from(e.merkleRoot,"hex").reverse()),{hash:e.hash,version:e.version,prevHash:r,merkleRoot:t,time:e.time,timestamp:e.time,bits:e.bits,nonce:e.nonce}},BlockHeader.fromObject=function(e){var r=BlockHeader._fromObject(e);return new BlockHeader(r)},BlockHeader.fromRawBlock=function(e){Buffer.isBuffer(e)||(e=Buffer.from(e,"binary"));var r=BufferReader(e);r.pos=BlockHeader.Constants.START_OF_HEADER;var t=BlockHeader._fromBufferReader(r);return new BlockHeader(t)},BlockHeader.fromBuffer=function(e){var r=BlockHeader._fromBufferReader(BufferReader(e));return new BlockHeader(r)},BlockHeader.fromString=function(e){var r=Buffer.from(e,"hex");return BlockHeader.fromBuffer(r)},BlockHeader._fromBufferReader=function(e){var r={};return r.version=e.readInt32LE(),r.prevHash=e.read(32),r.merkleRoot=e.read(32),r.time=e.readUInt32LE(),r.bits=e.readUInt32LE(),r.nonce=e.readUInt32LE(),r},BlockHeader.fromBufferReader=function(e){var r=BlockHeader._fromBufferReader(e);return new BlockHeader(r)},BlockHeader.prototype.toObject=BlockHeader.prototype.toJSON=function(){return{hash:this.hash,version:this.version,prevHash:Buffer.from(this.prevHash).reverse().toString("hex"),merkleRoot:Buffer.from(this.merkleRoot).reverse().toString("hex"),time:this.time,bits:this.bits,nonce:this.nonce}},BlockHeader.prototype.toBuffer=function(){return this.toBufferWriter().concat()},BlockHeader.prototype.toString=function(){return this.toBuffer().toString("hex")},BlockHeader.prototype.toBufferWriter=function(e){return e||(e=new BufferWriter),e.writeInt32LE(this.version),e.write(this.prevHash),e.write(this.merkleRoot),e.writeUInt32LE(this.time),e.writeUInt32LE(this.bits),e.writeUInt32LE(this.nonce),e},BlockHeader.prototype.getTargetDifficulty=function(e){e=e||this.bits;for(var r=new BN(16777215&e),t=8*((e>>>24)-3);t-- >0;)r=r.mul(new BN(2));return r},BlockHeader.prototype.getDifficulty=function(){var e=this.getTargetDifficulty(GENESIS_BITS).mul(new BN(Math.pow(10,8))),r=this.getTargetDifficulty(),t=e.div(r).toString(10),o=t.length-8;return t=t.slice(0,o)+"."+t.slice(o),parseFloat(t)},BlockHeader.prototype._getHash=function(){var e=this.toBuffer();return Hash.sha256sha256(e)};var idProperty={configurable:!1,enumerable:!0,get:function(){return this._id||(this._id=BufferReader(this._getHash()).readReverse().toString("hex")),this._id},set:_.noop};Object.defineProperty(BlockHeader.prototype,"id",idProperty),Object.defineProperty(BlockHeader.prototype,"hash",idProperty),BlockHeader.prototype.validTimestamp=function(){var e=Math.round((new Date).getTime()/1e3);return!(this.time>e+BlockHeader.Constants.MAX_TIME_OFFSET)},BlockHeader.prototype.validProofOfWork=function(){var e=new BN(this.id,"hex"),r=this.getTargetDifficulty();return!(e.cmp(r)>0)},BlockHeader.prototype.inspect=function(){return"<BlockHeader "+this.id+">"},BlockHeader.Constants={START_OF_HEADER:8,MAX_TIME_OFFSET:7200,LARGEST_HASH:new BN("10000000000000000000000000000000000000000000000000000000000000000","hex")},module.exports=BlockHeader;