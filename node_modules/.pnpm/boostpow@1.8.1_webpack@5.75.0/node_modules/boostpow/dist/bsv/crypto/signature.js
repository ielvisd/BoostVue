"use strict";var BN=require("./bn"),_=require("../util/_"),$=require("../util/preconditions"),JSUtil=require("../util/javas"),Signature=function r(e,t){if(!(this instanceof r))return new r(e,t);if(e instanceof BN)this.set({r:e,s:t});else if(e){var n=e;this.set(n)}};Signature.prototype.set=function(r){return this.r=r.r||this.r||void 0,this.s=r.s||this.s||void 0,this.i=void 0!==r.i?r.i:this.i,this.compressed=void 0!==r.compressed?r.compressed:this.compressed,this.nhashtype=r.nhashtype||this.nhashtype||void 0,this},Signature.fromCompact=function(r){$.checkArgument(Buffer.isBuffer(r),"Argument is expected to be a Buffer");var e=new Signature,t=!0,n=r.slice(0,1)[0]-27-4;n<0&&(t=!1,n+=4);var i=r.slice(1,33),u=r.slice(33,65);return $.checkArgument(0===n||1===n||2===n||3===n,new Error("i must be 0, 1, 2, or 3")),$.checkArgument(32===i.length,new Error("r must be 32 bytes")),$.checkArgument(32===u.length,new Error("s must be 32 bytes")),e.compressed=t,e.i=n,e.r=BN.fromBuffer(i),e.s=BN.fromBuffer(u),e},Signature.fromDER=Signature.fromBuffer=function(r,e){var t=Signature.parseDER(r,e),n=new Signature;return n.r=t.r,n.s=t.s,n},Signature.fromTxFormat=function(r){var e=r.readUInt8(r.length-1),t=r.slice(0,r.length-1),n=Signature.fromDER(t,!1);return n.nhashtype=e,n},Signature.fromString=function(r){var e=Buffer.from(r,"hex");return Signature.fromDER(e)},Signature.parseDER=function(r,e){$.checkArgument(Buffer.isBuffer(r),new Error("DER formatted signature should be a buffer")),_.isUndefined(e)&&(e=!0);var t=r[0];$.checkArgument(48===t,new Error("Header byte should be 0x30"));var n=r[1],i=r.slice(2).length;$.checkArgument(!e||n===i,new Error("Length byte should length of what follows")),n=n<i?n:i;var u=r[2];$.checkArgument(2===u,new Error("Integer byte for r should be 0x02"));var o=r[3],f=r.slice(4,4+o),s=BN.fromBuffer(f),a=0===r[4];$.checkArgument(o===f.length,new Error("Length of r incorrect"));var h=r[4+o+0];$.checkArgument(2===h,new Error("Integer byte for s should be 0x02"));var c=r[4+o+1],g=r.slice(4+o+2,4+o+2+c),S=BN.fromBuffer(g),m=0===r[4+o+2+2];$.checkArgument(c===g.length,new Error("Length of s incorrect"));var l=4+o+2+c;return $.checkArgument(n===l-2,new Error("Length of signature incorrect")),{header:t,length:n,rheader:u,rlength:o,rneg:a,rbuf:f,r:s,sheader:h,slength:c,sneg:m,sbuf:g,s:S}},Signature.prototype.toCompact=function(r,e){if(r="number"==typeof r?r:this.i,e="boolean"==typeof e?e:this.compressed,0!==r&&1!==r&&2!==r&&3!==r)throw new Error("i must be equal to 0, 1, 2, or 3");var t=r+27+4;!1===e&&(t-=4);var n=Buffer.from([t]),i=this.r.toBuffer({size:32}),u=this.s.toBuffer({size:32});return Buffer.concat([n,i,u])},Signature.prototype.toBuffer=Signature.prototype.toDER=function(){var r=this.r.toBuffer(),e=this.s.toBuffer(),t=!!(128&r[0]),n=!!(128&e[0]),i=t?Buffer.concat([Buffer.from([0]),r]):r,u=n?Buffer.concat([Buffer.from([0]),e]):e,o=i.length,f=u.length,s=2+o+2+f;return Buffer.concat([Buffer.from([48,s,2,o]),i,Buffer.from([2,f]),u])},Signature.prototype.toString=function(){return this.toDER().toString("hex")},Signature.isTxDER=function(r){if(r.length<9)return!1;if(r.length>73)return!1;if(48!==r[0])return!1;if(r[1]!==r.length-3)return!1;var e=r[3];if(5+e>=r.length)return!1;var t=r[5+e];if(e+t+7!==r.length)return!1;var n=r.slice(4);if(2!==r[2])return!1;if(0===e)return!1;if(128&n[0])return!1;if(e>1&&0===n[0]&&!(128&n[1]))return!1;var i=r.slice(6+e);return!(2!==r[6+e-2]||0===t||128&i[0]||t>1&&0===i[0]&&!(128&i[1]))},Signature.prototype.hasLowS=function(){return!this.s.lt(new BN(1))&&!this.s.gt(new BN("7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0","hex"))},Signature.prototype.hasDefinedHashtype=function(){if(!JSUtil.isNaturalNumber(this.nhashtype))return!1;var r=31&this.nhashtype;return!(r<Signature.SIGHASH_ALL||r>Signature.SIGHASH_SINGLE)},Signature.prototype.toTxFormat=function(){var r=this.toDER(),e=Buffer.alloc(1);return e.writeUInt8(this.nhashtype,0),Buffer.concat([r,e])},Signature.SIGHASH_ALL=1,Signature.SIGHASH_NONE=2,Signature.SIGHASH_SINGLE=3,Signature.SIGHASH_FORKID=64,Signature.SIGHASH_ANYONECANPAY=128,module.exports=Signature;