"use strict";var BN=require("./bn"),Point=require("./point"),Signature=require("./signature"),PublicKey=require("../publickey"),Random=require("./random"),Hash=require("./hash"),_=require("../util/_"),$=require("../util/preconditions"),ECDSA=function i(t){if(!(this instanceof i))return new i(t);t&&this.set(t)};ECDSA.prototype.set=function(i){return this.hashbuf=i.hashbuf||this.hashbuf,this.endian=i.endian||this.endian,this.privkey=i.privkey||this.privkey,this.pubkey=i.pubkey||(this.privkey?this.privkey.publicKey:this.pubkey),this.sig=i.sig||this.sig,this.k=i.k||this.k,this.verified=i.verified||this.verified,this},ECDSA.prototype.privkey2pubkey=function(){this.pubkey=this.privkey.toPublicKey()},ECDSA.prototype.calci=function(){for(var i=0;i<4;i++){var t;this.sig.i=i;try{t=this.toPublicKey()}catch(i){console.error(i);continue}if(t.point.eq(this.pubkey.point))return this.sig.compressed=this.pubkey.compressed,this}throw this.sig.i=void 0,new Error("Unable to find valid recovery factor")},ECDSA.fromString=function(i){var t=JSON.parse(i);return new ECDSA(t)},ECDSA.prototype.randomK=function(){var i,t=Point.getN();do{i=BN.fromBuffer(Random.getRandomBuffer(32))}while(!i.lt(t)||!i.gt(BN.Zero));return this.k=i,this},ECDSA.prototype.deterministicK=function(i){_.isUndefined(i)&&(i=0);var t=Buffer.alloc(32);t.fill(1);var e=Buffer.alloc(32);e.fill(0);var r=this.privkey.bn.toBuffer({size:32}),s="little"===this.endian?Buffer.from(this.hashbuf).reverse():this.hashbuf;e=Hash.sha256hmac(Buffer.concat([t,Buffer.from([0]),r,s]),e),t=Hash.sha256hmac(t,e),e=Hash.sha256hmac(Buffer.concat([t,Buffer.from([1]),r,s]),e),t=Hash.sha256hmac(t,e),t=Hash.sha256hmac(t,e);for(var n=BN.fromBuffer(t),h=Point.getN(),o=0;o<i||!n.lt(h)||!n.gt(BN.Zero);o++)e=Hash.sha256hmac(Buffer.concat([t,Buffer.from([0])]),e),t=Hash.sha256hmac(t,e),t=Hash.sha256hmac(t,e),n=BN.fromBuffer(t);return this.k=n,this},ECDSA.prototype.toPublicKey=function(){var i=this.sig.i;$.checkArgument(0===i||1===i||2===i||3===i,new Error("i must be equal to 0, 1, 2, or 3"));var t=BN.fromBuffer(this.hashbuf),e=this.sig.r,r=this.sig.s,s=1&i,n=i>>1,h=Point.getN(),o=Point.getG(),u=n?e.add(h):e,f=Point.fromX(s,u);if(!f.mul(h).isInfinity())throw new Error("nR is not a valid curve point");var a=t.neg().umod(h),c=e.invm(h),p=f.mul(r).add(o.mul(a)).mul(c);return PublicKey.fromPoint(p,this.sig.compressed)},ECDSA.prototype.sigError=function(){if(!Buffer.isBuffer(this.hashbuf)||32!==this.hashbuf.length)return"hashbuf must be a 32 byte buffer";var i=this.sig.r,t=this.sig.s;if(!(i.gt(BN.Zero)&&i.lt(Point.getN())&&t.gt(BN.Zero)&&t.lt(Point.getN())))return"r and s not in range";var e=BN.fromBuffer(this.hashbuf,this.endian?{endian:this.endian}:void 0),r=Point.getN(),s=t.invm(r),n=s.mul(e).umod(r),h=s.mul(i).umod(r),o=Point.getG().mulAdd(n,this.pubkey.point,h);return o.isInfinity()?"p is infinity":0!==o.getX().umod(r).cmp(i)&&"Invalid signature"},ECDSA.toLowS=function(i){return i.gt(BN.fromBuffer(Buffer.from("7FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF5D576E7357A4501DDFE92F46681B20A0","hex")))&&(i=Point.getN().sub(i)),i},ECDSA.prototype._findSignature=function(i,t){var e,r,s,n=Point.getN(),h=Point.getG(),o=0;do{(!this.k||o>0)&&this.deterministicK(o),o++,e=this.k,r=h.mul(e).x.umod(n),s=e.invm(n).mul(t.add(i.mul(r))).umod(n)}while(r.cmp(BN.Zero)<=0||s.cmp(BN.Zero)<=0);return{s:s=ECDSA.toLowS(s),r}},ECDSA.prototype.sign=function(){var i=this.hashbuf,t=this.privkey,e=t.bn;$.checkState(i&&t&&e,new Error("invalid parameters")),$.checkState(Buffer.isBuffer(i)&&32===i.length,new Error("hashbuf must be a 32 byte buffer"));var r=BN.fromBuffer(i,this.endian?{endian:this.endian}:void 0),s=this._findSignature(e,r);return s.compressed=this.pubkey.compressed,this.sig=new Signature(s),this},ECDSA.prototype.signRandomK=function(){return this.randomK(),this.sign()},ECDSA.prototype.toString=function(){var i={};return this.hashbuf&&(i.hashbuf=this.hashbuf.toString("hex")),this.privkey&&(i.privkey=this.privkey.toString()),this.pubkey&&(i.pubkey=this.pubkey.toString()),this.sig&&(i.sig=this.sig.toString()),this.k&&(i.k=this.k.toString()),JSON.stringify(i)},ECDSA.prototype.verify=function(){return this.sigError()?this.verified=!1:this.verified=!0,this},ECDSA.sign=function(i,t,e){return ECDSA().set({hashbuf:i,endian:e,privkey:t}).sign().sig},ECDSA.signWithCalcI=function(i,t,e){return ECDSA().set({hashbuf:i,endian:e,privkey:t}).sign().calci().sig},ECDSA.signRandomK=function(i,t,e){return ECDSA().set({hashbuf:i,endian:e,privkey:t}).signRandomK().sig},ECDSA.verify=function(i,t,e,r){return ECDSA().set({hashbuf:i,endian:r,sig:t,pubkey:e}).verify().verified},module.exports=ECDSA;