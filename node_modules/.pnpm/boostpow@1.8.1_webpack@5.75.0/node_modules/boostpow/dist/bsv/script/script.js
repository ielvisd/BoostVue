"use strict";var Address=require("../address"),BufferReader=require("../encoding/bufferreader"),BufferWriter=require("../encoding/bufferwriter"),Hash=require("../crypto/hash"),Opcode=require("../opcode"),PublicKey=require("../publickey"),Signature=require("../crypto/signature"),Networks=require("../networks"),$=require("../util/preconditions"),_=require("../util/_"),errors=require("../errors"),buffer=require("buffer"),JSUtil=require("../util/javas"),Script=function t(e){return this instanceof t?(this.chunks=[],Buffer.isBuffer(e)?t.fromBuffer(e):e instanceof Address?t.fromAddress(e):e instanceof t?t.fromBuffer(e.toBuffer()):_.isString(e)?t.fromString(e):void(_.isObject(e)&&_.isArray(e.chunks)&&this.set(e))):new t(e)};Script.prototype.set=function(t){return $.checkArgument(_.isObject(t)),$.checkArgument(_.isArray(t.chunks)),this.chunks=t.chunks,this},Script.fromBuffer=function(t){var e=new Script;e.chunks=[];for(var r=new BufferReader(t);!r.finished();)try{var i,n,u=r.readUInt8();u>0&&u<Opcode.OP_PUSHDATA1?(i=u,e.chunks.push({buf:r.read(i),len:i,opcodenum:u})):u===Opcode.OP_PUSHDATA1?(i=r.readUInt8(),n=r.read(i),e.chunks.push({buf:n,len:i,opcodenum:u})):u===Opcode.OP_PUSHDATA2?(i=r.readUInt16LE(),n=r.read(i),e.chunks.push({buf:n,len:i,opcodenum:u})):u===Opcode.OP_PUSHDATA4?(i=r.readUInt32LE(),n=r.read(i),e.chunks.push({buf:n,len:i,opcodenum:u})):e.chunks.push({opcodenum:u})}catch(e){if(e instanceof RangeError)throw new errors.Script.InvalidBuffer(t.toString("hex"));throw e}return e},Script.prototype.toBuffer=function(){for(var t=new BufferWriter,e=0;e<this.chunks.length;e++){var r=this.chunks[e],i=r.opcodenum;t.writeUInt8(r.opcodenum),r.buf&&(i<Opcode.OP_PUSHDATA1?t.write(r.buf):i===Opcode.OP_PUSHDATA1?(t.writeUInt8(r.len),t.write(r.buf)):i===Opcode.OP_PUSHDATA2?(t.writeUInt16LE(r.len),t.write(r.buf)):i===Opcode.OP_PUSHDATA4&&(t.writeUInt32LE(r.len),t.write(r.buf)))}return t.concat()},Script.fromASM=function(t){var e=new Script;e.chunks=[];for(var r=t.split(" "),i=0;i<r.length;){var n=r[i],u=Opcode(n).toNumber();if("0"===n)u=0,e.chunks.push({opcodenum:u}),i+=1;else if("-1"===n)u=Opcode.OP_1NEGATE,e.chunks.push({opcodenum:u}),i+=1;else if(_.isUndefined(u)){var s=Buffer.from(r[i],"hex");if(s.toString("hex")!==r[i])throw new Error("invalid hex string in script");var c=s.length;c>=0&&c<Opcode.OP_PUSHDATA1?u=c:c<Math.pow(2,8)?u=Opcode.OP_PUSHDATA1:c<Math.pow(2,16)?u=Opcode.OP_PUSHDATA2:c<Math.pow(2,32)&&(u=Opcode.OP_PUSHDATA4),e.chunks.push({buf:s,len:s.length,opcodenum:u}),i+=1}else e.chunks.push({opcodenum:u}),i+=1}return e},Script.fromHex=function(t){return new Script(buffer.Buffer.from(t,"hex"))},Script.fromString=function(t){if(JSUtil.isHexa(t)||0===t.length)return new Script(buffer.Buffer.from(t,"hex"));var e=new Script;e.chunks=[];for(var r=t.split(" "),i=0;i<r.length;){var n=r[i],u=Opcode(n).toNumber();if(_.isUndefined(u)){if(!((u=parseInt(n))>0&&u<Opcode.OP_PUSHDATA1))throw new Error("Invalid script: "+JSON.stringify(t));e.chunks.push({buf:Buffer.from(r[i+1].slice(2),"hex"),len:u,opcodenum:u}),i+=2}else if(u===Opcode.OP_PUSHDATA1||u===Opcode.OP_PUSHDATA2||u===Opcode.OP_PUSHDATA4){if("0x"!==r[i+2].slice(0,2))throw new Error("Pushdata data must start with 0x");e.chunks.push({buf:Buffer.from(r[i+2].slice(2),"hex"),len:parseInt(r[i+1]),opcodenum:u}),i+=3}else e.chunks.push({opcodenum:u}),i+=1}return e},Script.prototype._chunkToString=function(t,e){var r=t.opcodenum,i="asm"===e,n="";if(t.buf)i||r!==Opcode.OP_PUSHDATA1&&r!==Opcode.OP_PUSHDATA2&&r!==Opcode.OP_PUSHDATA4||(n=n+" "+Opcode(r).toString()),t.len>0&&(n=i?n+" "+t.buf.toString("hex"):n+" "+t.len+" 0x"+t.buf.toString("hex"));else if(void 0!==Opcode.reverseMap[r])i?0===r?n+=" 0":79===r?n+=" -1":n=n+" "+Opcode(r).toString():n=n+" "+Opcode(r).toString();else{var u=r.toString(16);u.length%2!=0&&(u="0"+u),n=i?n+" "+u:n+" 0x"+u}return n},Script.prototype.toASM=function(){for(var t="",e=0;e<this.chunks.length;e++){var r=this.chunks[e];t+=this._chunkToString(r,"asm")}return t.substr(1)},Script.prototype.toString=function(){for(var t="",e=0;e<this.chunks.length;e++){var r=this.chunks[e];t+=this._chunkToString(r)}return t.substr(1)},Script.prototype.toHex=function(){return this.toBuffer().toString("hex")},Script.prototype.inspect=function(){return"<Script: "+this.toString()+">"},Script.prototype.isPublicKeyHashOut=function(){return!(5!==this.chunks.length||this.chunks[0].opcodenum!==Opcode.OP_DUP||this.chunks[1].opcodenum!==Opcode.OP_HASH160||!this.chunks[2].buf||20!==this.chunks[2].buf.length||this.chunks[3].opcodenum!==Opcode.OP_EQUALVERIFY||this.chunks[4].opcodenum!==Opcode.OP_CHECKSIG)},Script.prototype.isPublicKeyHashIn=function(){if(2===this.chunks.length){var t=this.chunks[0].buf,e=this.chunks[1].buf;if(t&&t.length&&48===t[0]&&e&&e.length){var r=e[0];if((4===r||6===r||7===r)&&65===e.length)return!0;if((3===r||2===r)&&33===e.length)return!0}}return!1},Script.prototype.getPublicKey=function(){return $.checkState(this.isPublicKeyOut(),"Can't retrieve PublicKey from a non-PK output"),this.chunks[0].buf},Script.prototype.getPublicKeyHash=function(){return $.checkState(this.isPublicKeyHashOut(),"Can't retrieve PublicKeyHash from a non-PKH output"),this.chunks[2].buf},Script.prototype.isPublicKeyOut=function(){if(2===this.chunks.length&&this.chunks[0].buf&&this.chunks[0].buf.length&&this.chunks[1].opcodenum===Opcode.OP_CHECKSIG){var t=this.chunks[0].buf,e=t[0],r=!1;if((4!==e&&6!==e&&7!==e||65!==t.length)&&(3!==e&&2!==e||33!==t.length)||(r=!0),r)return PublicKey.isValid(t)}return!1},Script.prototype.isPublicKeyIn=function(){if(1===this.chunks.length){var t=this.chunks[0].buf;if(t&&t.length&&48===t[0])return!0}return!1},Script.prototype.isScriptHashOut=function(){var t=this.toBuffer();return 23===t.length&&t[0]===Opcode.OP_HASH160&&20===t[1]&&t[t.length-1]===Opcode.OP_EQUAL},Script.prototype.isScriptHashIn=function(){if(this.chunks.length<=1)return!1;var t,e=this.chunks[this.chunks.length-1].buf;if(!e)return!1;try{t=Script.fromBuffer(e)}catch(t){if(t instanceof errors.Script.InvalidBuffer)return!1;throw t}return t.classify()!==Script.types.UNKNOWN},Script.prototype.isMultisigOut=function(){return this.chunks.length>3&&Opcode.isSmallIntOp(this.chunks[0].opcodenum)&&this.chunks.slice(1,this.chunks.length-2).every((function(t){return t.buf&&Buffer.isBuffer(t.buf)}))&&Opcode.isSmallIntOp(this.chunks[this.chunks.length-2].opcodenum)&&this.chunks[this.chunks.length-1].opcodenum===Opcode.OP_CHECKMULTISIG},Script.prototype.isMultisigIn=function(){return this.chunks.length>=2&&0===this.chunks[0].opcodenum&&this.chunks.slice(1,this.chunks.length).every((function(t){return t.buf&&Buffer.isBuffer(t.buf)&&Signature.isTxDER(t.buf)}))},Script.prototype.isDataOut=function(){if(!(this.chunks.length>=1&&this.chunks[0].opcodenum===Opcode.OP_RETURN))return!1;var t=this.chunks.slice(1);return new Script({chunks:t}).isPushOnly()},Script.prototype.isSafeDataOut=function(){if(this.chunks.length<2)return!1;if(this.chunks[0].opcodenum!==Opcode.OP_FALSE)return!1;var t=this.chunks.slice(1);return new Script({chunks:t}).isDataOut()},Script.prototype.getData=function(){if(this.isSafeDataOut())return this.chunks.slice(2).map((t=>t.buf));if(this.isDataOut()||this.isScriptHashOut())return _.isUndefined(this.chunks[1])?Buffer.alloc(0):Buffer.from(this.chunks[1].buf);if(this.isPublicKeyHashOut())return Buffer.from(this.chunks[2].buf);throw new Error("Unrecognized script type to get data from")},Script.prototype.isPushOnly=function(){return _.every(this.chunks,(function(t){return t.opcodenum<=Opcode.OP_16||t.opcodenum===Opcode.OP_PUSHDATA1||t.opcodenum===Opcode.OP_PUSHDATA2||t.opcodenum===Opcode.OP_PUSHDATA4}))},Script.types={},Script.types.UNKNOWN="Unknown",Script.types.PUBKEY_OUT="Pay to public key",Script.types.PUBKEY_IN="Spend from public key",Script.types.PUBKEYHASH_OUT="Pay to public key hash",Script.types.PUBKEYHASH_IN="Spend from public key hash",Script.types.SCRIPTHASH_OUT="Pay to script hash",Script.types.SCRIPTHASH_IN="Spend from script hash",Script.types.MULTISIG_OUT="Pay to multisig",Script.types.MULTISIG_IN="Spend from multisig",Script.types.DATA_OUT="Data push",Script.types.SAFE_DATA_OUT="Safe data push",Script.OP_RETURN_STANDARD_SIZE=220,Script.prototype.classify=function(){if(this._isInput)return this.classifyInput();if(this._isOutput)return this.classifyOutput();var t=this.classifyOutput();return t!==Script.types.UNKNOWN?t:this.classifyInput()},Script.outputIdentifiers={},Script.outputIdentifiers.PUBKEY_OUT=Script.prototype.isPublicKeyOut,Script.outputIdentifiers.PUBKEYHASH_OUT=Script.prototype.isPublicKeyHashOut,Script.outputIdentifiers.MULTISIG_OUT=Script.prototype.isMultisigOut,Script.outputIdentifiers.SCRIPTHASH_OUT=Script.prototype.isScriptHashOut,Script.outputIdentifiers.DATA_OUT=Script.prototype.isDataOut,Script.outputIdentifiers.SAFE_DATA_OUT=Script.prototype.isSafeDataOut,Script.prototype.classifyOutput=function(){for(var t in Script.outputIdentifiers)if(Script.outputIdentifiers[t].bind(this)())return Script.types[t];return Script.types.UNKNOWN},Script.inputIdentifiers={},Script.inputIdentifiers.PUBKEY_IN=Script.prototype.isPublicKeyIn,Script.inputIdentifiers.PUBKEYHASH_IN=Script.prototype.isPublicKeyHashIn,Script.inputIdentifiers.MULTISIG_IN=Script.prototype.isMultisigIn,Script.inputIdentifiers.SCRIPTHASH_IN=Script.prototype.isScriptHashIn,Script.prototype.classifyInput=function(){for(var t in Script.inputIdentifiers)if(Script.inputIdentifiers[t].bind(this)())return Script.types[t];return Script.types.UNKNOWN},Script.prototype.isStandard=function(){return this.classify()!==Script.types.UNKNOWN},Script.prototype.prepend=function(t){return this._addByType(t,!0),this},Script.prototype.equals=function(t){if($.checkState(t instanceof Script,"Must provide another script"),this.chunks.length!==t.chunks.length)return!1;var e;for(e=0;e<this.chunks.length;e++){if(Buffer.isBuffer(this.chunks[e].buf)&&!Buffer.isBuffer(t.chunks[e].buf))return!1;if(Buffer.isBuffer(this.chunks[e].buf)&&!this.chunks[e].buf.equals(t.chunks[e].buf))return!1;if(this.chunks[e].opcodenum!==t.chunks[e].opcodenum)return!1}return!0},Script.prototype.add=function(t){return this._addByType(t,!1),this},Script.prototype._addByType=function(t,e){if("string"==typeof t)this._addOpcode(t,e);else if("number"==typeof t)this._addOpcode(t,e);else if(t instanceof Opcode)this._addOpcode(t,e);else if(Buffer.isBuffer(t))this._addBuffer(t,e);else if(t instanceof Script)this.chunks=this.chunks.concat(t.chunks);else{if("object"!=typeof t)throw new Error("Invalid script chunk");this._insertAtPosition(t,e)}},Script.prototype._insertAtPosition=function(t,e){e?this.chunks.unshift(t):this.chunks.push(t)},Script.prototype._addOpcode=function(t,e){var r;return r="number"==typeof t?t:t instanceof Opcode?t.toNumber():Opcode(t).toNumber(),this._insertAtPosition({opcodenum:r},e),this},Script.prototype._addBuffer=function(t,e){var r,i=t.length;if(i>=0&&i<Opcode.OP_PUSHDATA1)r=i;else if(i<Math.pow(2,8))r=Opcode.OP_PUSHDATA1;else if(i<Math.pow(2,16))r=Opcode.OP_PUSHDATA2;else{if(!(i<Math.pow(2,32)))throw new Error("You can't push that much data");r=Opcode.OP_PUSHDATA4}return this._insertAtPosition({buf:t,len:i,opcodenum:r},e),this},Script.prototype.removeCodeseparators=function(){for(var t=[],e=0;e<this.chunks.length;e++)this.chunks[e].opcodenum!==Opcode.OP_CODESEPARATOR&&t.push(this.chunks[e]);return this.chunks=t,this},Script.buildMultisigOut=function(t,e,r){$.checkArgument(e<=t.length,"Number of required signatures must be less than or equal to the number of public keys"),r=r||{};var i=new Script;i.add(Opcode.smallInt(e));var n=t=_.map(t,PublicKey);r.noSorting||(n=t.map((t=>t.toString("hex"))).sort().map((t=>new PublicKey(t))));for(var u=0;u<n.length;u++){var s=n[u];i.add(s.toBuffer())}return i.add(Opcode.smallInt(t.length)),i.add(Opcode.OP_CHECKMULTISIG),i},Script.buildMultisigIn=function(t,e,r){$.checkArgument(_.isArray(t)),$.checkArgument(_.isNumber(e)),$.checkArgument(_.isArray(r));var i=new Script;return i.add(Opcode.OP_0),_.each(r,(function(t){$.checkArgument(Buffer.isBuffer(t),"Signatures must be an array of Buffers"),i.add(t)})),i},Script.buildP2SHMultisigIn=function(t,e,r,i){$.checkArgument(_.isArray(t)),$.checkArgument(_.isNumber(e)),$.checkArgument(_.isArray(r)),i=i||{};var n=new Script;return n.add(Opcode.OP_0),_.each(r,(function(t){$.checkArgument(Buffer.isBuffer(t),"Signatures must be an array of Buffers"),n.add(t)})),n.add((i.cachedMultisig||Script.buildMultisigOut(t,e,i)).toBuffer()),n},Script.buildPublicKeyHashOut=function(t){$.checkArgument(!_.isUndefined(t)),$.checkArgument(t instanceof PublicKey||t instanceof Address||_.isString(t)),t instanceof PublicKey?t=t.toAddress():_.isString(t)&&(t=new Address(t));var e=new Script;return e.add(Opcode.OP_DUP).add(Opcode.OP_HASH160).add(t.hashBuffer).add(Opcode.OP_EQUALVERIFY).add(Opcode.OP_CHECKSIG),e._network=t.network,e},Script.buildPublicKeyOut=function(t){$.checkArgument(t instanceof PublicKey);var e=new Script;return e.add(t.toBuffer()).add(Opcode.OP_CHECKSIG),e},Script.buildDataOut=function(t,e){$.checkArgument(_.isUndefined(t)||_.isString(t)||_.isArray(t)||Buffer.isBuffer(t));var r=t;_.isArray(r)||(r=[t]);var i=new Script;i.add(Opcode.OP_RETURN);for(let t of r)$.checkArgument(_.isUndefined(t)||_.isString(t)||Buffer.isBuffer(t)),_.isString(t)&&(t=Buffer.from(t,e)),_.isUndefined(t)||i.add(t);return i},Script.buildSafeDataOut=function(t,e){var r=Script.buildDataOut(t,e),i=new Script;return i.add(Opcode.OP_FALSE),i.add(r),i},Script.buildScriptHashOut=function(t){$.checkArgument(t instanceof Script||t instanceof Address&&t.isPayToScriptHash());var e=new Script;return e.add(Opcode.OP_HASH160).add(t instanceof Address?t.hashBuffer:Hash.sha256ripemd160(t.toBuffer())).add(Opcode.OP_EQUAL),e._network=t._network||t.network,e},Script.buildPublicKeyIn=function(t,e){$.checkArgument(t instanceof Signature||Buffer.isBuffer(t)),$.checkArgument(_.isUndefined(e)||_.isNumber(e)),t instanceof Signature&&(t=t.toBuffer());var r=new Script;return r.add(Buffer.concat([t,Buffer.from([255&(e||Signature.SIGHASH_ALL)])])),r},Script.buildPublicKeyHashIn=function(t,e,r){return $.checkArgument(e instanceof Signature||Buffer.isBuffer(e)),$.checkArgument(_.isUndefined(r)||_.isNumber(r)),e instanceof Signature&&(e=e.toBuffer()),(new Script).add(Buffer.concat([e,Buffer.from([255&(r||Signature.SIGHASH_ALL)])])).add(new PublicKey(t).toBuffer())},Script.empty=function(){return new Script},Script.prototype.toScriptHashOut=function(){return Script.buildScriptHashOut(this)},Script.fromAddress=function(t){if((t=Address(t)).isPayToScriptHash())return Script.buildScriptHashOut(t);if(t.isPayToPublicKeyHash())return Script.buildPublicKeyHashOut(t);throw new errors.Script.UnrecognizedAddress(t)},Script.prototype.getAddressInfo=function(){return this._isInput?this._getInputAddressInfo():this._isOutput?this._getOutputAddressInfo():this._getOutputAddressInfo()||this._getInputAddressInfo()},Script.prototype._getOutputAddressInfo=function(){var t={};if(this.isScriptHashOut())t.hashBuffer=this.getData(),t.type=Address.PayToScriptHash;else{if(!this.isPublicKeyHashOut())return!1;t.hashBuffer=this.getData(),t.type=Address.PayToPublicKeyHash}return t},Script.prototype._getInputAddressInfo=function(){var t={};if(this.isPublicKeyHashIn())t.hashBuffer=Hash.sha256ripemd160(this.chunks[1].buf),t.type=Address.PayToPublicKeyHash;else{if(!this.isScriptHashIn())return!1;t.hashBuffer=Hash.sha256ripemd160(this.chunks[this.chunks.length-1].buf),t.type=Address.PayToScriptHash}return t},Script.prototype.toAddress=function(t){var e=this.getAddressInfo();return!!e&&(e.network=Networks.get(t)||this._network||Networks.defaultNetwork,new Address(e))},Script.prototype.findAndDelete=function(t){for(var e=t.toBuffer().toString("hex"),r=0;r<this.chunks.length;r++)e===Script({chunks:[this.chunks[r]]}).toBuffer().toString("hex")&&this.chunks.splice(r,1);return this},Script.prototype.checkMinimalPush=function(t){var e=this.chunks[t],r=e.buf,i=e.opcodenum;return!(r&&(0===r.length?i!==Opcode.OP_0:1===r.length&&r[0]>=1&&r[0]<=16?i!==Opcode.OP_1+(r[0]-1):1===r.length&&129===r[0]?i!==Opcode.OP_1NEGATE:r.length<=75?i!==r.length:r.length<=255?i!==Opcode.OP_PUSHDATA1:r.length<=65535&&i!==Opcode.OP_PUSHDATA2))},Script.prototype._decodeOP_N=function(t){if(t===Opcode.OP_0)return 0;if(t>=Opcode.OP_1&&t<=Opcode.OP_16)return t-(Opcode.OP_1-1);throw new Error("Invalid opcode: "+JSON.stringify(t))},Script.prototype.getSignatureOperationsCount=function(t){t=!!_.isUndefined(t)||t;var e=this,r=0,i=Opcode.OP_INVALIDOPCODE;return _.each(e.chunks,(function(n){var u=n.opcodenum;u===Opcode.OP_CHECKSIG||u===Opcode.OP_CHECKSIGVERIFY?r++:u!==Opcode.OP_CHECKMULTISIG&&u!==Opcode.OP_CHECKMULTISIGVERIFY||(t&&i>=Opcode.OP_1&&i<=Opcode.OP_16?r+=e._decodeOP_N(i):r+=20),i=u})),r},module.exports=Script;