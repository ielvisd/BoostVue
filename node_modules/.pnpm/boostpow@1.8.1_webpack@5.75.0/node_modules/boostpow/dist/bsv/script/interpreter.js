"use strict";var _=require("../util/_"),Script=require("./script"),Opcode=require("../opcode"),BN=require("../crypto/bn"),Hash=require("../crypto/hash"),Signature=require("../crypto/signature"),PublicKey=require("../publickey"),cloneDeep=require("clone-deep"),Interpreter=function e(t){if(!(this instanceof e))return new e(t);t?(this.initialize(),this.set(t)):this.initialize()};function padBufferToSize(e,t){let r=e;for(;r.length<t;)r=Buffer.concat([Buffer.from([0]),r]);return r}Interpreter.prototype.verify=function(e,t,r,s,i,c){var I,h=require("../transaction");if(_.isUndefined(r)&&(r=new h),_.isUndefined(s)&&(s=0),_.isUndefined(i)&&(i=0),i&Interpreter.SCRIPT_ENABLE_SIGHASH_FORKID&&(i|=Interpreter.SCRIPT_VERIFY_STRICTENC,!c))throw new Error("internal error - need satoshisBN to verify FORKID transactions");if(this.set({script:e,tx:r,nin:s,flags:i,satoshisBN:c}),0!=(i&Interpreter.SCRIPT_VERIFY_SIGPUSHONLY)&&!e.isPushOnly())return this.errstr="SCRIPT_ERR_SIG_PUSHONLY",!1;if(!this.evaluate())return!1;i&Interpreter.SCRIPT_VERIFY_P2SH&&(I=this.stack.slice());var n=this.stack;if(this.initialize(),this.set({script:t,stack:n,tx:r,nin:s,flags:i,satoshisBN:c}),!this.evaluate())return!1;if(0===this.stack.length)return this.errstr="SCRIPT_ERR_EVAL_FALSE_NO_RESULT",!1;var O=this.stack[this.stack.length-1];if(!Interpreter.castToBool(O))return this.errstr="SCRIPT_ERR_EVAL_FALSE_IN_STACK",!1;if(i&Interpreter.SCRIPT_VERIFY_P2SH&&t.isScriptHashOut()){if(!e.isPushOnly())return this.errstr="SCRIPT_ERR_SIG_PUSHONLY",!1;if(0===I.length)throw new Error("internal error - stack copy empty");var a=I[I.length-1],R=Script.fromBuffer(a);if(I.pop(),this.initialize(),this.set({script:R,stack:I,tx:r,nin:s,flags:i,satoshisBN:c}),!this.evaluate())return!1;if(0===I.length)return this.errstr="SCRIPT_ERR_EVAL_FALSE_NO_P2SH_STACK",!1;if(!Interpreter.castToBool(I[I.length-1]))return this.errstr="SCRIPT_ERR_EVAL_FALSE_IN_P2SH_STACK",!1}if(0!=(i&Interpreter.SCRIPT_VERIFY_CLEANSTACK)){if(0==(i&Interpreter.SCRIPT_VERIFY_P2SH))throw new Error("internal error - CLEANSTACK without P2SH");if(1!==I.length)return this.errstr="SCRIPT_ERR_CLEANSTACK",!1}return!0},module.exports=Interpreter,Interpreter.prototype.initialize=function(){this.stack=[],this.altstack=[],this.pc=0,this.pbegincodehash=0,this.nOpCount=0,this.vfExec=[],this.errstr="",this.flags=0},Interpreter.prototype.set=function(e){this.script=e.script||this.script,this.tx=e.tx||this.tx,this.nin=void 0!==e.nin?e.nin:this.nin,this.satoshisBN=e.satoshisBN||this.satoshisBN,this.stack=e.stack||this.stack,this.altstack=e.altstack||this.altstack,this.pc=void 0!==e.pc?e.pc:this.pc,this.pbegincodehash=void 0!==e.pbegincodehash?e.pbegincodehash:this.pbegincodehash,this.nOpCount=void 0!==e.nOpCount?e.nOpCount:this.nOpCount,this.vfExec=e.vfExec||this.vfExec,this.errstr=e.errstr||this.errstr,this.flags=void 0!==e.flags?e.flags:this.flags},Interpreter.true=Buffer.from([1]),Interpreter.false=Buffer.from([]),Interpreter.MAX_SCRIPT_ELEMENT_SIZE=520,Interpreter.MAXIMUM_ELEMENT_SIZE=4,Interpreter.LOCKTIME_THRESHOLD=5e8,Interpreter.LOCKTIME_THRESHOLD_BN=new BN(Interpreter.LOCKTIME_THRESHOLD),Interpreter.SCRIPT_VERIFY_NONE=0,Interpreter.SCRIPT_VERIFY_P2SH=1,Interpreter.SCRIPT_VERIFY_STRICTENC=2,Interpreter.SCRIPT_VERIFY_DERSIG=4,Interpreter.SCRIPT_VERIFY_LOW_S=8,Interpreter.SCRIPT_VERIFY_NULLDUMMY=16,Interpreter.SCRIPT_VERIFY_SIGPUSHONLY=32,Interpreter.SCRIPT_VERIFY_MINIMALDATA=64,Interpreter.SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS=128,Interpreter.SCRIPT_VERIFY_CLEANSTACK=256,Interpreter.SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY=512,Interpreter.SCRIPT_VERIFY_CHECKSEQUENCEVERIFY=1024,Interpreter.SCRIPT_VERIFY_MINIMALIF=8192,Interpreter.SCRIPT_VERIFY_NULLFAIL=16384,Interpreter.SCRIPT_VERIFY_COMPRESSED_PUBKEYTYPE=32768,Interpreter.SCRIPT_ENABLE_SIGHASH_FORKID=65536,Interpreter.SCRIPT_ENABLE_REPLAY_PROTECTION=1<<17,Interpreter.SCRIPT_ENABLE_MONOLITH_OPCODES=1<<18,Interpreter.SCRIPT_ENABLE_MAGNETIC_OPCODES=1<<19,Interpreter.SEQUENCE_LOCKTIME_DISABLE_FLAG=1<<31,Interpreter.SEQUENCE_LOCKTIME_TYPE_FLAG=1<<22,Interpreter.SEQUENCE_LOCKTIME_MASK=65535,Interpreter.castToBool=function(e){for(var t=0;t<e.length;t++)if(0!==e[t])return t!==e.length-1||128!==e[t];return!1},Interpreter.prototype.checkSignatureEncoding=function(e){var t;if(0===e.length)return!0;if(0!=(this.flags&(Interpreter.SCRIPT_VERIFY_DERSIG|Interpreter.SCRIPT_VERIFY_LOW_S|Interpreter.SCRIPT_VERIFY_STRICTENC))&&!Signature.isTxDER(e))return this.errstr="SCRIPT_ERR_SIG_DER_INVALID_FORMAT",!1;if(0!=(this.flags&Interpreter.SCRIPT_VERIFY_LOW_S)){if(!(t=Signature.fromTxFormat(e)).hasLowS())return this.errstr="SCRIPT_ERR_SIG_DER_HIGH_S",!1}else if(0!=(this.flags&Interpreter.SCRIPT_VERIFY_STRICTENC)){if(!(t=Signature.fromTxFormat(e)).hasDefinedHashtype())return this.errstr="SCRIPT_ERR_SIG_HASHTYPE",!1;if(!(this.flags&Interpreter.SCRIPT_ENABLE_SIGHASH_FORKID)&&t.nhashtype&Signature.SIGHASH_FORKID)return this.errstr="SCRIPT_ERR_ILLEGAL_FORKID",!1;if(this.flags&Interpreter.SCRIPT_ENABLE_SIGHASH_FORKID&&!(t.nhashtype&Signature.SIGHASH_FORKID))return this.errstr="SCRIPT_ERR_MUST_USE_FORKID",!1}return!0},Interpreter.prototype.checkPubkeyEncoding=function(e){return!(0!=(this.flags&Interpreter.SCRIPT_VERIFY_STRICTENC)&&!PublicKey.isValid(e)&&(this.errstr="SCRIPT_ERR_PUBKEYTYPE",1))},Interpreter._isMinimallyEncoded=function(e,t){return t=t||Interpreter.MAXIMUM_ELEMENT_SIZE,!(e.length>t||e.length>0&&0==(127&e[e.length-1])&&(e.length<=1||0==(128&e[e.length-2])))},Interpreter._minimallyEncode=function(e){if(0===e.length)return e;var t=e[e.length-1];if(127&t)return e;if(1===e.length)return Buffer.from("");if(128&e[e.length-2])return e;for(var r=e.length-1;r>0;r--)if(0!==e[r-1])return 128&e[r-1]?e[r++]=t:e[r-1]|=t,e.slice(0,r);return Buffer.from("")},Interpreter.prototype.evaluate=function(){if(this.script.toBuffer().length>1e4)return this.errstr="SCRIPT_ERR_SCRIPT_SIZE",!1;try{for(;this.pc<this.script.chunks.length;){let e={pc:this.pc,opcode:Opcode.fromNumber(this.script.chunks[this.pc].opcodenum)};if(!this.step())return!1;this._callbackStep(e)}if(this.stack.length+this.altstack.length>1e3)return this.errstr="SCRIPT_ERR_STACK_SIZE",!1}catch(e){return this.errstr="SCRIPT_ERR_UNKNOWN_ERROR: "+e,!1}return!(this.vfExec.length>0&&(this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",1))},Interpreter.prototype._callbackStep=function(e){if("function"==typeof this.stepListener)try{this.stepListener(e,cloneDeep(this.stack,!0),cloneDeep(this.altstack,!0))}catch(e){console.log(`Error in Step callback:${e}`)}},Interpreter.prototype.checkLockTime=function(e){return!!(this.tx.nLockTime<Interpreter.LOCKTIME_THRESHOLD&&e.lt(Interpreter.LOCKTIME_THRESHOLD_BN)||this.tx.nLockTime>=Interpreter.LOCKTIME_THRESHOLD&&e.gte(Interpreter.LOCKTIME_THRESHOLD_BN))&&!e.gt(new BN(this.tx.nLockTime))&&!this.tx.inputs[this.nin].isFinal()},Interpreter.prototype.checkSequence=function(e){var t=this.tx.inputs[this.nin].sequenceNumber;if(this.tx.version<2)return!1;if(t&Interpreter.SEQUENCE_LOCKTIME_DISABLE_FLAG)return!1;var r=Interpreter.SEQUENCE_LOCKTIME_TYPE_FLAG|Interpreter.SEQUENCE_LOCKTIME_MASK,s=new BN(t&r),i=e.and(r),c=new BN(Interpreter.SEQUENCE_LOCKTIME_TYPE_FLAG);return!!(s.lt(c)&&i.lt(c)||s.gte(c)&&i.gte(c))&&!i.gt(s)},Interpreter.prototype.step=function(){var e=this;function t(t){return e.stack[e.stack.length+t]}var r,s,i,c,I,h,n,O,a,R,p,E,P,o,S,T,f,N=0!=(this.flags&Interpreter.SCRIPT_VERIFY_MINIMALDATA),u=-1===this.vfExec.indexOf(!1),C=this.script.chunks[this.pc];this.pc++;var A=C.opcodenum;if(_.isUndefined(A))return this.errstr="SCRIPT_ERR_UNDEFINED_OPCODE",!1;if(C.buf&&C.buf.length>Interpreter.MAX_SCRIPT_ELEMENT_SIZE)return this.errstr="SCRIPT_ERR_PUSH_SIZE",!1;if(A>Opcode.OP_16&&++this.nOpCount>201)return this.errstr="SCRIPT_ERR_OP_COUNT",!1;if(function(t){switch(t){case Opcode.OP_2MUL:case Opcode.OP_2DIV:return!0;case Opcode.OP_INVERT:case Opcode.OP_MUL:case Opcode.OP_LSHIFT:case Opcode.OP_RSHIFT:if(0==(e.flags&Interpreter.SCRIPT_ENABLE_MAGNETIC_OPCODES))return!0;break;case Opcode.OP_DIV:case Opcode.OP_MOD:case Opcode.OP_SPLIT:case Opcode.OP_CAT:case Opcode.OP_AND:case Opcode.OP_OR:case Opcode.OP_XOR:case Opcode.OP_BIN2NUM:case Opcode.OP_NUM2BIN:if(0==(e.flags&Interpreter.SCRIPT_ENABLE_MONOLITH_OPCODES))return!0}return!1}(A))return this.errstr="SCRIPT_ERR_DISABLED_OPCODE",!1;if(u&&A>=0&&A<=Opcode.OP_PUSHDATA4){if(N&&!this.script.checkMinimalPush(this.pc-1))return this.errstr="SCRIPT_ERR_MINIMALDATA",!1;if(C.buf){if(C.len!==C.buf.length)throw new Error(`Length of push value not equal to length of data (${C.len},${C.buf.length})`);this.stack.push(C.buf)}else this.stack.push(Interpreter.false)}else if(u||Opcode.OP_IF<=A&&A<=Opcode.OP_ENDIF)switch(A){case Opcode.OP_1NEGATE:case Opcode.OP_1:case Opcode.OP_2:case Opcode.OP_3:case Opcode.OP_4:case Opcode.OP_5:case Opcode.OP_6:case Opcode.OP_7:case Opcode.OP_8:case Opcode.OP_9:case Opcode.OP_10:case Opcode.OP_11:case Opcode.OP_12:case Opcode.OP_13:case Opcode.OP_14:case Opcode.OP_15:case Opcode.OP_16:I=A-(Opcode.OP_1-1),r=new BN(I).toScriptNumBuffer(),this.stack.push(r);break;case Opcode.OP_NOP:break;case Opcode.OP_NOP2:case Opcode.OP_CHECKLOCKTIMEVERIFY:if(!(this.flags&Interpreter.SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY)){if(this.flags&Interpreter.SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS)return this.errstr="SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS",!1;break}if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var k=BN.fromScriptNumBuffer(this.stack[this.stack.length-1],N,5);if(k.lt(new BN(0)))return this.errstr="SCRIPT_ERR_NEGATIVE_LOCKTIME",!1;if(!this.checkLockTime(k))return this.errstr="SCRIPT_ERR_UNSATISFIED_LOCKTIME",!1;break;case Opcode.OP_NOP3:case Opcode.OP_CHECKSEQUENCEVERIFY:if(!(this.flags&Interpreter.SCRIPT_VERIFY_CHECKSEQUENCEVERIFY)){if(this.flags&Interpreter.SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS)return this.errstr="SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS",!1;break}if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var l=BN.fromScriptNumBuffer(t(-1),N,5);if(l.lt(new BN(0)))return this.errstr="SCRIPT_ERR_NEGATIVE_LOCKTIME",!1;if(0!=(l&Interpreter.SEQUENCE_LOCKTIME_DISABLE_FLAG))break;if(!this.checkSequence(l))return this.errstr="SCRIPT_ERR_UNSATISFIED_LOCKTIME",!1;break;case Opcode.OP_NOP1:case Opcode.OP_NOP4:case Opcode.OP_NOP5:case Opcode.OP_NOP6:case Opcode.OP_NOP7:case Opcode.OP_NOP8:case Opcode.OP_NOP9:case Opcode.OP_NOP10:if(this.flags&Interpreter.SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS)return this.errstr="SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS",!1;break;case Opcode.OP_IF:case Opcode.OP_NOTIF:if(T=!1,u){if(this.stack.length<1)return this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",!1;if(r=t(-1),this.flags&Interpreter.SCRIPT_VERIFY_MINIMALIF){if(r.length>1)return this.errstr="SCRIPT_ERR_MINIMALIF",!1;if(1===r.length&&1!==r[0])return this.errstr="SCRIPT_ERR_MINIMALIF",!1}T=Interpreter.castToBool(r),A===Opcode.OP_NOTIF&&(T=!T),this.stack.pop()}this.vfExec.push(T);break;case Opcode.OP_ELSE:if(0===this.vfExec.length)return this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",!1;this.vfExec[this.vfExec.length-1]=!this.vfExec[this.vfExec.length-1];break;case Opcode.OP_ENDIF:if(0===this.vfExec.length)return this.errstr="SCRIPT_ERR_UNBALANCED_CONDITIONAL",!1;this.vfExec.pop();break;case Opcode.OP_VERIFY:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(r=t(-1),!(T=Interpreter.castToBool(r)))return this.errstr="SCRIPT_ERR_VERIFY",!1;this.stack.pop();break;case Opcode.OP_RETURN:return this.errstr="SCRIPT_ERR_OP_RETURN",!1;case Opcode.OP_TOALTSTACK:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.altstack.push(this.stack.pop());break;case Opcode.OP_FROMALTSTACK:if(this.altstack.length<1)return this.errstr="SCRIPT_ERR_INVALID_ALTSTACK_OPERATION",!1;this.stack.push(this.altstack.pop());break;case Opcode.OP_2DROP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.pop(),this.stack.pop();break;case Opcode.OP_2DUP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;s=t(-2),i=t(-1),this.stack.push(Buffer.from(s)),this.stack.push(Buffer.from(i));break;case Opcode.OP_3DUP:if(this.stack.length<3)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;s=t(-3),i=t(-2);var d=t(-1);this.stack.push(Buffer.from(s)),this.stack.push(Buffer.from(i)),this.stack.push(Buffer.from(d));break;case Opcode.OP_2OVER:if(this.stack.length<4)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;s=t(-4),i=t(-3),this.stack.push(Buffer.from(s)),this.stack.push(Buffer.from(i));break;case Opcode.OP_2ROT:if(this.stack.length<6)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;c=this.stack.splice(this.stack.length-6,2),this.stack.push(c[0]),this.stack.push(c[1]);break;case Opcode.OP_2SWAP:if(this.stack.length<4)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;c=this.stack.splice(this.stack.length-4,2),this.stack.push(c[0]),this.stack.push(c[1]);break;case Opcode.OP_IFDUP:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;r=t(-1),(T=Interpreter.castToBool(r))&&this.stack.push(Buffer.from(r));break;case Opcode.OP_DEPTH:r=new BN(this.stack.length).toScriptNumBuffer(),this.stack.push(r);break;case Opcode.OP_DROP:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.pop();break;case Opcode.OP_DUP:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.push(Buffer.from(t(-1)));break;case Opcode.OP_NIP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.splice(this.stack.length-2,1);break;case Opcode.OP_OVER:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.push(Buffer.from(t(-2)));break;case Opcode.OP_PICK:case Opcode.OP_ROLL:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(r=t(-1),I=(O=BN.fromScriptNumBuffer(r,N)).toNumber(),this.stack.pop(),I<0||I>=this.stack.length)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;r=t(-I-1),A===Opcode.OP_ROLL&&this.stack.splice(this.stack.length-I-1,1),this.stack.push(Buffer.from(r));break;case Opcode.OP_ROT:if(this.stack.length<3)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;h=t(-3),n=t(-2);var L=t(-1);this.stack[this.stack.length-3]=n,this.stack[this.stack.length-2]=L,this.stack[this.stack.length-1]=h;break;case Opcode.OP_SWAP:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;h=t(-2),n=t(-1),this.stack[this.stack.length-2]=n,this.stack[this.stack.length-1]=h;break;case Opcode.OP_TUCK:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;this.stack.splice(this.stack.length-2,0,Buffer.from(t(-1)));break;case Opcode.OP_SIZE:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;O=new BN(t(-1).length),this.stack.push(O.toScriptNumBuffer());break;case Opcode.OP_AND:case Opcode.OP_OR:case Opcode.OP_XOR:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(s=t(-2),i=t(-1),s.length!==i.length)return this.errstr="SCRIPT_ERR_INVALID_OPERAND_SIZE",!1;switch(A){case Opcode.OP_AND:for(let e=0;e<s.length;e++)s[e]&=i[e];break;case Opcode.OP_OR:for(let e=0;e<s.length;e++)s[e]|=i[e];break;case Opcode.OP_XOR:for(let e=0;e<s.length;e++)s[e]^=i[e]}this.stack.pop();break;case Opcode.OP_INVERT:this.stack.length<1&&(this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION"),r=t(-1);for(let e=0;e<r.length;e++)r[e]=~r[e];break;case Opcode.OP_LSHIFT:case Opcode.OP_RSHIFT:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(0===(s=t(-2)).length)this.stack.pop();else{if(a=new BN(s),(I=(R=BN.fromScriptNumBuffer(t(-1),N)).toNumber())<0)return this.errstr="SCRIPT_ERR_INVALID_NUMBER_RANGE",!1;let e;this.stack.pop(),this.stack.pop(),A===Opcode.OP_LSHIFT&&(e=a.ushln(I)),A===Opcode.OP_RSHIFT&&(e=a.ushrn(I));let r=padBufferToSize(Buffer.from(e.toArray().slice(-1*s.length)),s.length);this.stack.push(r)}break;case Opcode.OP_EQUAL:case Opcode.OP_EQUALVERIFY:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;s=t(-2),i=t(-1);var g=s.toString("hex")===i.toString("hex");if(this.stack.pop(),this.stack.pop(),this.stack.push(g?Interpreter.true:Interpreter.false),A===Opcode.OP_EQUALVERIFY){if(!g)return this.errstr="SCRIPT_ERR_EQUALVERIFY",!1;this.stack.pop()}break;case Opcode.OP_1ADD:case Opcode.OP_1SUB:case Opcode.OP_NEGATE:case Opcode.OP_ABS:case Opcode.OP_NOT:case Opcode.OP_0NOTEQUAL:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;switch(r=t(-1),O=BN.fromScriptNumBuffer(r,N),A){case Opcode.OP_1ADD:O=O.add(BN.One);break;case Opcode.OP_1SUB:O=O.sub(BN.One);break;case Opcode.OP_NEGATE:O=O.neg();break;case Opcode.OP_ABS:O.cmp(BN.Zero)<0&&(O=O.neg());break;case Opcode.OP_NOT:O=new BN((0===O.cmp(BN.Zero))+0);break;case Opcode.OP_0NOTEQUAL:O=new BN((0!==O.cmp(BN.Zero))+0)}this.stack.pop(),this.stack.push(O.toScriptNumBuffer());break;case Opcode.OP_ADD:case Opcode.OP_SUB:case Opcode.OP_MUL:case Opcode.OP_MOD:case Opcode.OP_DIV:case Opcode.OP_BOOLAND:case Opcode.OP_BOOLOR:case Opcode.OP_NUMEQUAL:case Opcode.OP_NUMEQUALVERIFY:case Opcode.OP_NUMNOTEQUAL:case Opcode.OP_LESSTHAN:case Opcode.OP_GREATERTHAN:case Opcode.OP_LESSTHANOREQUAL:case Opcode.OP_GREATERTHANOREQUAL:case Opcode.OP_MIN:case Opcode.OP_MAX:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;switch(a=BN.fromScriptNumBuffer(t(-2),N),R=BN.fromScriptNumBuffer(t(-1),N),O=new BN(0),A){case Opcode.OP_ADD:O=a.add(R);break;case Opcode.OP_SUB:O=a.sub(R);break;case Opcode.OP_MUL:O=a.mul(R);break;case Opcode.OP_DIV:if(0===R)return this.errstr="SCRIPT_ERR_DIV_BY_ZERO",!1;O=a.div(R);break;case Opcode.OP_MOD:if(0===R)return this.errstr="SCRIPT_ERR_DIV_BY_ZERO",!1;O=a.mod(R);break;case Opcode.OP_BOOLAND:O=new BN((0!==a.cmp(BN.Zero)&&0!==R.cmp(BN.Zero))+0);break;case Opcode.OP_BOOLOR:O=new BN((0!==a.cmp(BN.Zero)||0!==R.cmp(BN.Zero))+0);break;case Opcode.OP_NUMEQUAL:case Opcode.OP_NUMEQUALVERIFY:O=new BN((0===a.cmp(R))+0);break;case Opcode.OP_NUMNOTEQUAL:O=new BN((0!==a.cmp(R))+0);break;case Opcode.OP_LESSTHAN:O=new BN((a.cmp(R)<0)+0);break;case Opcode.OP_GREATERTHAN:O=new BN((a.cmp(R)>0)+0);break;case Opcode.OP_LESSTHANOREQUAL:O=new BN((a.cmp(R)<=0)+0);break;case Opcode.OP_GREATERTHANOREQUAL:O=new BN((a.cmp(R)>=0)+0);break;case Opcode.OP_MIN:O=a.cmp(R)<0?a:R;break;case Opcode.OP_MAX:O=a.cmp(R)>0?a:R}if(this.stack.pop(),this.stack.pop(),this.stack.push(O.toScriptNumBuffer()),A===Opcode.OP_NUMEQUALVERIFY){if(!Interpreter.castToBool(t(-1)))return this.errstr="SCRIPT_ERR_NUMEQUALVERIFY",!1;this.stack.pop()}break;case Opcode.OP_WITHIN:if(this.stack.length<3)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;a=BN.fromScriptNumBuffer(t(-3),N),R=BN.fromScriptNumBuffer(t(-2),N);var B=BN.fromScriptNumBuffer(t(-1),N);T=R.cmp(a)<=0&&a.cmp(B)<0,this.stack.pop(),this.stack.pop(),this.stack.pop(),this.stack.push(T?Interpreter.true:Interpreter.false);break;case Opcode.OP_RIPEMD160:case Opcode.OP_SHA1:case Opcode.OP_SHA256:case Opcode.OP_HASH160:case Opcode.OP_HASH256:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var D;r=t(-1),A===Opcode.OP_RIPEMD160?D=Hash.ripemd160(r):A===Opcode.OP_SHA1?D=Hash.sha1(r):A===Opcode.OP_SHA256?D=Hash.sha256(r):A===Opcode.OP_HASH160?D=Hash.sha256ripemd160(r):A===Opcode.OP_HASH256&&(D=Hash.sha256sha256(r)),this.stack.pop(),this.stack.push(D);break;case Opcode.OP_CODESEPARATOR:this.pbegincodehash=this.pc;break;case Opcode.OP_CHECKSIG:case Opcode.OP_CHECKSIGVERIFY:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(p=t(-2),E=t(-1),!this.checkSignatureEncoding(p)||!this.checkPubkeyEncoding(E))return!1;P=(new Script).set({chunks:this.script.chunks.slice(this.pbegincodehash)});var U=(new Script).add(p);P.findAndDelete(U);try{o=Signature.fromTxFormat(p),S=PublicKey.fromBuffer(E,!1),f=this.tx.verifySignature(o,S,this.nin,P,this.satoshisBN,this.flags)}catch(e){f=!1}if(!f&&this.flags&Interpreter.SCRIPT_VERIFY_NULLFAIL&&p.length)return this.errstr="SCRIPT_ERR_NULLFAIL",!1;if(this.stack.pop(),this.stack.pop(),this.stack.push(f?Interpreter.true:Interpreter.false),A===Opcode.OP_CHECKSIGVERIFY){if(!f)return this.errstr="SCRIPT_ERR_CHECKSIGVERIFY",!1;this.stack.pop()}break;case Opcode.OP_CHECKMULTISIG:case Opcode.OP_CHECKMULTISIGVERIFY:var V=1;if(this.stack.length<V)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var m=BN.fromScriptNumBuffer(t(-V),N).toNumber();if(m<0||m>20)return this.errstr="SCRIPT_ERR_PUBKEY_COUNT",!1;if(this.nOpCount+=m,this.nOpCount>201)return this.errstr="SCRIPT_ERR_OP_COUNT",!1;var F=++V;V+=m;var K=m+2;if(this.stack.length<V)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var b=BN.fromScriptNumBuffer(t(-V),N).toNumber();if(b<0||b>m)return this.errstr="SCRIPT_ERR_SIG_COUNT",!1;var M=++V;if(V+=b,this.stack.length<V)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;P=(new Script).set({chunks:this.script.chunks.slice(this.pbegincodehash)});for(var H=0;H<b;H++)p=t(-M-H),P.findAndDelete((new Script).add(p));for(f=!0;f&&b>0;){if(p=t(-M),E=t(-F),!this.checkSignatureEncoding(p)||!this.checkPubkeyEncoding(E))return!1;var Y;try{o=Signature.fromTxFormat(p),S=PublicKey.fromBuffer(E,!1),Y=this.tx.verifySignature(o,S,this.nin,P,this.satoshisBN,this.flags)}catch(e){Y=!1}Y&&(M++,b--),F++,b>--m&&(f=!1)}for(;V-- >1;){if(!f&&this.flags&Interpreter.SCRIPT_VERIFY_NULLFAIL&&!K&&t(-1).length)return this.errstr="SCRIPT_ERR_NULLFAIL",!1;K>0&&K--,this.stack.pop()}if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(this.flags&Interpreter.SCRIPT_VERIFY_NULLDUMMY&&t(-1).length)return this.errstr="SCRIPT_ERR_SIG_NULLDUMMY",!1;if(this.stack.pop(),this.stack.push(f?Interpreter.true:Interpreter.false),A===Opcode.OP_CHECKMULTISIGVERIFY){if(!f)return this.errstr="SCRIPT_ERR_CHECKMULTISIGVERIFY",!1;this.stack.pop()}break;case Opcode.OP_CAT:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(s=t(-2),i=t(-1),s.length+i.length>Interpreter.MAX_SCRIPT_ELEMENT_SIZE)return this.errstr="SCRIPT_ERR_PUSH_SIZE",!1;this.stack[this.stack.length-2]=Buffer.concat([s,i]),this.stack.pop();break;case Opcode.OP_SPLIT:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;s=t(-2);var v=BN.fromScriptNumBuffer(t(-1),N).toNumber();if(v<0||v>s.length)return this.errstr="SCRIPT_ERR_INVALID_SPLIT_RANGE",!1;var G=Buffer.from(s);this.stack[this.stack.length-2]=G.slice(0,v),this.stack[this.stack.length-1]=G.slice(v);break;case Opcode.OP_NUM2BIN:if(this.stack.length<2)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;var y=BN.fromScriptNumBuffer(t(-1),N).toNumber();if(y>Interpreter.MAX_SCRIPT_ELEMENT_SIZE)return this.errstr="SCRIPT_ERR_PUSH_SIZE",!1;this.stack.pop();var w=t(-1);if((w=Interpreter._minimallyEncode(w)).length>y)return this.errstr="SCRIPT_ERR_IMPOSSIBLE_ENCODING",!1;if(w.length===y){this.stack[this.stack.length-1]=w;break}var x=0;w.length>0&&(x=128&w[w.length-1],w[w.length-1]&=127);var Q=Buffer.alloc(y);w.copy(Q,0);for(var Z=w.length-1;Z++<y-2;)Q[Z]=0;Q[Z]=x,this.stack[this.stack.length-1]=Q;break;case Opcode.OP_BIN2NUM:if(this.stack.length<1)return this.errstr="SCRIPT_ERR_INVALID_STACK_OPERATION",!1;if(s=t(-1),i=Interpreter._minimallyEncode(s),this.stack[this.stack.length-1]=i,!Interpreter._isMinimallyEncoded(i))return this.errstr="SCRIPT_ERR_INVALID_NUMBER_RANGE",!1;break;default:return this.errstr="SCRIPT_ERR_BAD_OPCODE",!1}return!0};